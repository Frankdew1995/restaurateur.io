!function(ionic){"use strict";angular.module("ScrollPage",["ionic"]).directive("scrollPages",function(){return{restrict:"A"}}).directive("scrollPage",function(){return{restrict:"E",template:'<div class="scroll-page" style="height:'+window.innerHeight+'px"><div class="page-wrapper" ng-transclude></div></div>',transclude:!0,require:"^scrollPages"}})}(window.ionic);var SystemUtils=function(){"use strict";String.prototype.format=function(){var args=arguments;return this.replace(/\{(\d+)\}/g,function(s,i){return args[i]})},Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12===0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()},week={0:"天",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"};/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"星期":"周":"")+week[this.getDay()+""]));for(var k in o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt},Array.prototype.append=function(otherArray){otherArray.forEach(function(v){this.push(v)},this)};var _getUrlVars=function(name){for(var hash,vars=[],hashes=window.location.href.slice(window.location.href.lastIndexOf("?")+1).split("&"),i=0;i<hashes.length;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars[name]};return{getUrlVars:_getUrlVars}}(),app=angular.module("webOrder",["ionic","ScrollPage"]);app.config(function($stateProvider,$urlRouterProvider,$httpProvider){"use strict";$urlRouterProvider.when("","/root/21cad17f3c25444fa64e91b664551fc5/S1/B2/192.168.1.191"),$stateProvider.state("root",{url:"/root/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/root.htm?v=2017-12-15",controller:"CtrlRoot",cache:!0}).state("pay",{url:"/pay/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/pay.htm?v=4",controller:"CtrlPay"}).state("pay2",{url:"/pay2/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/pay2.htm?v=4",controller:"CtrlPay2"}).state("checkpay",{url:"/checkpay/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/checkpay.htm?v=4",controller:"CtrlCheckpay"}).state("login",{url:"/login/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/login.htm",controller:"CtrlLogin"}).state("qrcode",{url:"/qrcode/:sellerId/:storeId/:tableNum/:wxmemberpay/:orderDomain",templateUrl:"tml/qrcode.htm?v=1",controller:"CtrlQRCode",cache:!1}).state("wxqrcode",{url:"/wxqrcode/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/wxqrcode.htm?v=2",controller:"CtrlWXQRCode",cache:!1}).state("server",{url:"/server/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/server-order.htm?v=3",controller:"CtrlServer",cache:!1}).state("order",{url:"/order/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/order-v.htm?v=2016.05.01.16.50",controller:"CtrlOrder",cache:!1}).state("orderv2",{url:"/orderv2/:sellerId/:storeId/:tableNum/:orderDomain",templateUrl:"tml/order-v2.htm?v=2016.05.01.16.50",controller:"CtrlOrderV2",cache:!0}).state("preorderv2",{url:"/preorderv2/:sellerId/:storeId",templateUrl:"tml/pre-order-v2.htm?v=2017.05.01.16.50",controller:"CtrlPreOrderV2",cache:!0}).state("ordered",{url:"/ordered/:sellerId/:storeId/:tableNum/:orderDomain",cache:!1,templateUrl:"tml/ordered-foods.htm?v=3",controller:"CtrlOrdered"}).state("preordered",{url:"/preordered/:sellerId/:storeId",cache:!1,templateUrl:"tml/pre-ordered-foods.htm?v=8",controller:"CtrlPreOrdered"})}),app.directive("errSrc",function(){"use strict";return{restrict:"A",link:function(scope,element,attrs){element.bind("error",function(){attrs.src!=attrs.errSrc&&attrs.$set("src",attrs.errSrc)})}}}),app.service("serviceLog",function(){"use strict";var config={debug:!0};this.print=function(pre,infor){config.debug&&(infor?console.log(pre,infor):console.log(pre))}}),app.service("serviceConfig",function($interval,$rootScope,$window,serviceLog,Dialog){"use strict";this.test=!1,this.dicDomain="http://wx.yumstone.com/weixin",this.themeDomain="http://wxcdn.yumstone.com/weixin",this.orderDomain="../",this.serviceSuffix=".do",this.refreshTime=5e3,this.isStoreCacheResource=!1,this.sellerId="1bdd91819d2c4381abec4d891ba890ff",this.storeId="101",this.tableNum="101",this.waiter="",this.ascode="",this.cover=1,this.dogNum="00000000",this.picDataVersion="",this.constDefine={PIC_DATA_V2:"v2",LOCAL_MENU_KEY:"menudata",LOCAL_MENU_VER:"menuversion"};var _timer,_UID_KEY="uid",closeTimer=function(){$interval.cancel(_timer)};$rootScope.$on("$stateChangeStart",function(){closeTimer(),Dialog.close()}),this.getAccessCount=function(){return _count},this.setTimer=function(timer){_timer=timer},this.setUid=function(value){$window.localStorage[_UID_KEY]=value},this.removeUid=function(){$window.localStorage.removeItem(_UID_KEY)},this.getUid=function(){return $window.localStorage[_UID_KEY]||""},this.changeTitle=function(title){var $body=$("body");document.title=title;var $iframe=$('<iframe src="/favicon.ico"></iframe>');$iframe.on("load",function(){setTimeout(function(){$iframe.off("load").remove()},0)}).appendTo($body)},this.checkClient=function(){var ua=$window.navigator.userAgent.toLowerCase();return"micromessenger"==ua.match(/MicroMessenger/i)?1:"alipay"==ua.match(/alipay/i)?2:0},this.getStaticResourceHead=function(){if(this.test)return"";if(this.isStoreCacheResource){var resourceUrl=encodeURI("{0}/document/".format(this.dicDomain));return"http://{0}/onlineorder/wxstatic.do?url={1}".format(this.orderDomain,resourceUrl)}return this.dicDomain+"/document/"},this.clearWaiter=function(){this.waiter="",this.ascode=""}}),app.service("AppData",function(serviceConfig,$state,serviceLog){"use strict";this.orderQty=0;var _sideDishData=[];this.setSideDish=function(sd){_sideDishData=sd},this.getLocalSideDishData=function(){return _sideDishData};var menuData=[],picData=[];this.getLocalMenuData=function(){return menuData},this.setMenuData=function(md){menuData=md},this.getLocalPicData=function(){return picData},this.setPicData=function(pd){picData=pd},this.getMenuItemData=function(itemCode){for(var selMenuItems=[],foodType={},i=0;i<menuData.length;++i)if(0===menuData[i].isGroup||"0"===menuData[i].isGroup)for(var menuitems=menuData[i].menuitem,j=0;j<menuitems.length;++j)menuitems[j].code==itemCode&&(foodType.code=menuData[i].code,foodType.name=menuData[i].name,foodType.num=0,foodType.isGroup=0,selMenuItems.push(menuitems[j]));return 0===selMenuItems.length?(serviceLog.print("Don't find any fooditem!"),!1):(foodType.menuItems=selMenuItems,foodType)};var suiteHead={};this.setSuiteHead=function(opt){suiteHead.code=opt.code,suiteHead.name=opt.name,suiteHead.num=opt.num,suiteHead.isGroup=1},this.getSuiteHead=function(){return suiteHead},this.getMenuSuiteItemData=function(itemCode){for(var i=0;i<menuData.length;++i)if(1==menuData[i].isGroup)for(var menuSuites=menuData[i].menuitem,j=0;j<menuSuites.length;++j)if(menuSuites[j].code==itemCode)return suiteHead.code=menuData[i].code,suiteHead.name=menuData[i].name,suiteHead.isGroup=1,menuSuites[j];return serviceConfig.print("Don't find any suite food!"),!1}}),app.service("Dialog",function($ionicPopup,$rootScope){"use strict";var dialog;this.showAlert=function(title,msg,finish){this.close();var alertPopup=$ionicPopup.alert({title:'<img src="imgs/logo-b.svg" class="img-logo">'+title,template:msg,okText:"确定",okType:"button-df ion-checkmark-round"});dialog=alertPopup,finish&&alertPopup.then(function(){finish()})},this.showConfirm=function(title,msg,okText,cancelText,yes,no){var confirmPopup=$ionicPopup.confirm({title:'<img src="imgs/logo-b.svg" class="img-logo">'+title,template:msg,okText:okText,cancelText:cancelText,okType:"button-df ion-checkmark-round",cancelType:"button-df ion-close-round"});dialog=confirmPopup,confirmPopup.then(function(res){res?yes&&yes():no&&no()})},this.showTemplateConfirm=function(options,yes,no){var confirmPopup=$ionicPopup.confirm(options);dialog=confirmPopup,confirmPopup.then(function(res){res?yes&&yes(res):no&&no()})},this.showSelectQty=function(obj,yes,no){var $scope=$rootScope.$new();$scope.qty=1,$scope.menu=obj,$scope.qtyMinus=function(){$scope.qty--,$scope.qty=Math.max(0,$scope.qty)},$scope.qtyPlus=function(){$scope.qty++};var options={title:'<img src="imgs/logo-b.svg" class="img-logo">&nbsp;&nbsp;请输入数量',template:'<div class="df-font menuitem" style="padding: 6px 0;"><h4>{{menu.name}}</h4><div class="price">零点价:<span>{{menu.price*1}}</span>元/{{menu.standard}}</div><div ng-hide="!menu.memberprice||menu.memberprice*1>=menu.price*1" class="price">会员价:<span>{{menu.memberprice*1}}</span>元/{{menu.standard}}</div></div><div class="qty-wrapper margin-top-10"><div class="row qty"><div class="col col-25 minus" ng-click="qtyMinus()"><i class="ion-minus-round"></i></div><div class="col col-50 qty-text">{{qty}}</div><div class="col col-25 plus" ng-click="qtyPlus()"><i class="ion-plus-round"></i></div></div></div>',okText:"确定",okType:"button-df ion-checkmark-round",cancelText:"取消",cancelType:"button-df ion-close-round",scope:$scope},confirmPopup=$ionicPopup.confirm(options);dialog=confirmPopup,confirmPopup.then(function(res){res?yes&&yes($scope.qty):no&&no()})},this.close=function(){dialog&&dialog.close()},this.showAlterPeople=function(title,tableNum,yes,no){var $scope=$rootScope.$new();$scope.cover=1,$scope.tableNum=tableNum;var confirmPopup=$ionicPopup.confirm({title:'<img src="imgs/logo-b.svg" class="img-logo">'+title||"",template:'<div class="list">  <div class="item-input-inset" style="padding:5px;">    <span>当前桌号：</span>    <label class="item-input-wrapper">      <input type="text" value="{{tableNum}}" ng-readonly="{{true}}"  style="background:none;">    </label>  </div>  <div class="item-input-inset" style="padding:5px;">    <span>就餐人数：</span>    <label class="item-input-wrapper">      <input type="text" ng-model="cover" ng-readonly="{{true}}" style="background:none;">    </label>    <button class="button button-small button-balanced" ng-click="bnMinus()"><i class="icon ion-minus-round"></i></button>    <button class="button button-small button-positive" ng-click="bnAdd()" style="margin-left: 10px;"><i class="icon ion-plus-round"></i></button>  </div></div>',cssClass:"popup-df",scope:$scope,buttons:[{text:"取消",type:"button-df ion-close-round"},{text:"确定",type:"button-df ion-checkmark-round",onTap:function(e){return!0}}]});dialog=confirmPopup,$scope.bnMinus=function(){$scope.cover--,$scope.cover=Math.max(1,$scope.cover)},$scope.bnAdd=function(){$scope.cover++},confirmPopup.then(function(res){res?yes({cover:$scope.cover,waiter:"",ascode:""}):no&&no()})},this.showPayClass=function(title,data,yes,no){var $scope=$rootScope.$new();1==data.clientType?($scope.payText="微信/微信会员",$scope.otherPay="支付宝"):2==data.clientType?($scope.payText="支付宝",$scope.otherPay="微信/微信会员"):($scope.payText="微信/微信会员",$scope.otherPay="支付宝"),$scope.amount=data.amount;var confirmPopup=$ionicPopup.confirm({title:'<img src="imgs/logo-b.svg" class="img-logo">'+title||"",template:'<div><p>应付金额:<span style="color:#FF8444">{{amount}}</span>元</p><button class="button button-balanced" style="border-radius:5px;line-height:35px;min-height:35px;width:90%;" ng-click="bnOk()">{{payText}}支付</button></div><div style="margin:10px;padding-top:10px;border-top:1px solid #ccc;"><p style="margin:2px;">如使用<span style="color:#FF8444">{{otherPay}}</span>支付</p><p>请使用<span style="color:#FF8444">{{otherPay}}</span>扫桌贴二维码</p><button class="button button-stable" style="border-radius:5px;line-height:35px;min-height:35px;width:95%;" ng-click="bnCancel()">取消</button></div>',cssClass:"popup-df1",scope:$scope});dialog=confirmPopup,$scope.bnOk=function(){confirmPopup.close(),yes&&yes()},$scope.bnCancel=function(){confirmPopup.close(),no&&no()}}}),app.service("serviceHttp",function($http,$ionicLoading,$timeout,serviceConfig,Dialog,AppData,serviceLog,serviceUtils){"use strict";function parserRes(res,funCallback,isHideError){return 0===res.resultNumber||"0"===res.resultNumber?!angular.isObject(res.resultObject)||res.resultObject:(isHideError||Dialog.showAlert("温馨提示",res.resultMsg,funCallback),!1)}function newGuid(){for(var guid="",i=0;i<32;i++){var n=Math.floor(16*Math.random()).toString(16);guid+=n,8!=i&&16!=i&&24!=i&&32!=i||(guid+="-")}return guid}this.getNoPayBill=function(success){if($ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取已下清单...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/no-pay-bill.json";$http.get(url).success(function(data){serviceLog.print("T_GetNoPayBill Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取订单接口错误!")})},1e3);else{var url="http://{0}/onlineorder/bill/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("GetNoPayBill Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取订单接口错误!")})}},this.getOrderedFood=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取已点清单...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/ordered.json?v=1";$http.get(url).success(function(data){serviceLog.print("T_GetOrderedFood Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取已经点菜清单!")})},1e3);else{var url="http://{0}/onlineorder/order/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("GetOrderedFood Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){Dialog.showAlert("温馨提示","网络错误:获取已经点菜清单!")})}},this.operateOrderFoodNum=function(food,success){if(serviceConfig.test)$timeout(function(){var url="test/test-data/response.json";$http.get(url).success(function(data){serviceLog.print("T_OperateOrderFoodNum Response:",data),success&&success()}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:操作已点菜品的数量！")})},50);else{var url="http://{0}/onlineorder/order/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.put(url,food).success(function(data){serviceLog.print("operateOrderFoodNum Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:操作已点菜品的数量！")})}},this.login=function(uid,pwd,success){if($ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在登录验证...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/response.json";$http.get(url).success(function(data){serviceLog.print("T_OperateOrderFoodNum Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success()}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:登录接口出错！")})},1e3);else{var url="http://{0}/onlineorder/login{1}".format(serviceConfig.orderDomain,serviceConfig.serviceSuffix);$http.post(url,{uid:uid,ascode:pwd}).success(function(data){serviceLog.print("login Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:登录接口出错！")})}},this.createUidFromServer=function(success){if(serviceConfig.test)$timeout(function(){success&&success(newGuid())},1e3);else{var url="http://{0}/onlineorder/uid{1}".format(serviceConfig.orderDomain,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("CreateUidFromServer Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d.uid)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","在服务器创建身份：网络错误!")})}},this.addFood=function(food,success){if(serviceLog.print("AddFood:",food),serviceConfig.test)$timeout(function(){var url="test/test-data/response.json";$http.get(url).success(function(data){serviceLog.print("AddFood Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:添加菜品！")})},1e3);else{var url="http://{0}/onlineorder/order/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.post(url,food).success(function(data){serviceLog.print("AddFood Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:添加菜品！")})}},this.getBillState=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取订单状态...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/billstate.json";$http.get(url).success(function(data){serviceLog.print("T_GetBillState Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取订单状态!")})},1e3);else{var url="http://{0}/onlineorder/table/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("GetBillState Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取订单状态!")})}},this.order2bill=function(reqData,success,error){if(serviceLog.print("order2bill Requst:",reqData),$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在提交订单...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/ordered-response.json";$http.get(url).success(function(data){serviceLog.print("T_Order2bill Response:",data),$ionicLoading.hide();var _d=parserRes(data,error);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:下单接口!")})},1e3);else{var url="http://{0}/onlineorder/bill/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.post(url,reqData).success(function(data,reqData){serviceLog.print("order2bill Response:",data),$ionicLoading.hide();var _d=parserRes(data,error);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:下单接口!")})}},this.getPayTypes=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取支付方式...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/paytypes.json";$http.get(url).success(function(data){serviceLog.print("T_GetPayTypes Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取支付方式接口!")})},1e3);else{var url="http://{0}/onlineorder/paytypes{1}".format(serviceConfig.orderDomain,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("GetPayTypes Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取支付方式接口!")})}},this.aliPay=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在向支付宝提交数据...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/payresult.json";$http.get(url).success(function(data){serviceLog.print("T_Alipay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:支付宝支付接口!")})},1e3);else{var url="http://{0}/onlineorder/alipay/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.post(url).success(function(data){serviceLog.print("AliPay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:支付宝支付接口!")})}},this.weixinPay=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在向微信提交数据...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/payresult.json";$http.get(url).success(function(data){serviceLog.print("T_WeixinPay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:微信支付接口!")})},1e3);else{var url="http://{0}/onlineorder/weixinpay/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.post(url).success(function(data){serviceLog.print("WeixinPay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:微信支付接口!")})}},this.weixinMemberPay=function(success,hideLoading){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在向微信会员提交数据...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/payresult.json?v=2";$http.get(url).success(function(data){serviceLog.print("T_WeixinMemberPay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:微信会员支付接口!")})},1e3);else{var url="http://{0}/onlineorder/wxmemberpay/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.post(url).success(function(data){serviceLog.print("weixinMemberPay Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:微信会员支付接口!")})}},this.checkPay=function(hideLoading,success,error){if(hideLoading||$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在检查支付是否完成...'}),serviceConfig.test)$timeout(function(){var url="test/test-data/response.json";$http.get(url).success(function(data){serviceLog.print("T_CheckPay Response:",data),$ionicLoading.hide(),0===data.resultNumber||"0"===data.resultNumber?success&&success():error&&error(data.resultMsg)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:检查支付是否完成接口!")})},1e3);else{var url="http://{0}/onlineorder/checkpay/{1}{2}".format(serviceConfig.orderDomain,serviceConfig.tableNum,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("CheckPay Response:",data),$ionicLoading.hide(),0===data.resultNumber||"0"===data.resultNumber?success&&success():error&&error(data.resultMsg)}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:检查支付是否完成接口!")})}},this.getSaleoutFromStore=function(success){if(serviceConfig.test)$timeout(function(){var url="test/test-data/response.json";$http.get(url).success(function(data){serviceLog.print("T_Saleout Response:",data),$ionicLoading.hide();var _d=parserRes(data);_d&&success&&success()}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取沽清接口!")})},1e3);else{var url="http://{0}/onlineorder/saleout{1}".format(serviceConfig.orderDomain,serviceConfig.serviceSuffix);$http.get(url).success(function(data){serviceLog.print("Saleout Response:",data);var _d=parserRes(data);_d&&success&&success(_d)}).error(function(){$ionicLoading.hide()})}},this.checkResourceCache=function(funCallback){var url="http://{0}/onlineorder/wxstaticcachable{1}".format(serviceConfig.orderDomain,serviceConfig.serviceSuffix);serviceLog.print("checkResourceCache Url:"+url),$http.get(url).success(function(data){serviceLog.print("checkResourceCache Response:",data),serviceConfig.isStoreCacheResource=!0,funCallback&&funCallback()}).error(function(){serviceConfig.isStoreCacheResource=!1,funCallback&&funCallback()})},this.getMenuData=function(isShowLoad,finish){if(isShowLoad&&$ionicLoading.show({template:"加载菜单数据数据..."}),serviceConfig.test)$http.get("test/test-data/menus.json").success(function(data){$ionicLoading.hide(),serviceLog.print("T_GetMenuData Response:",angular.toJson(data));var menuData=data.menudata;AppData.setMenuData(menuData),finish&&finish(menuData)}).error(function(data,status,headers,config){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取菜单失败!")});else{var url="{0}/document/{1}/menus/release/{2}/0/menudata.json?v={3}".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId,(new Date).valueOf());$http.get(url).success(function(data){$ionicLoading.hide(),console.log("GetMenuData Response:",angular.toJson(data));var menuData=data.menudata;AppData.setMenuData(menuData),finish&&finish(menuData)}).error(function(data){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取菜单失败!")})}},this.getMenuDataVersion=function(funCallback){if(serviceConfig.test){var url="test/test-data/menudataver.json?v=9";$http.get(url).success(function(data){0==data.resultNumber?funCallback&&(serviceUtils.setMenuVersionCache(data.resultObject.version),funCallback(data.resultObject.version)):funCallback&&funCallback("")}).error(function(data){funCallback&&funCallback("")})}else{var url="{0}/wxmenusetup/v2/menuversion.html?sellerid={1}&storeid={2}".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId);$http.get(url).success(function(data){0==data.resultNumber?funCallback&&(serviceUtils.setMenuVersionCache(data.resultObject.version),funCallback(data.resultObject.version)):funCallback&&funCallback("")}).error(function(data){funCallback&&funCallback("")})}},this.getOriginMenuData=function(funCallback){var getData=function(){if($ionicLoading.show({template:"正在加载菜单数据..."}),angular.isArray(serviceUtils.menuData)&&serviceUtils.menuData.length>0)serviceLog.print("从缓存中加载菜单数据..."),$ionicLoading.hide(),funCallback&&funCallback(serviceUtils.menuData);else if(serviceConfig.test){var url="test/test-data/originmenus_test.json";$timeout(function(){$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("T_GetOriginMenuData Response:",data);var res=parserRes(data);serviceUtils.createMenuData(res.menuData,res.suiteData),res&&funCallback&&funCallback()}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取菜单数据!<br>Url:"+url)})},1e3)}else{var url="{0}/wxmenusetup/v2/originmenu.html?sellerid={1}&storeid={2}".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId);serviceLog.print("GetOriginMenuData Url:",url),$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("GetOriginMenuData Response:",data);var res=parserRes(data);serviceUtils.createMenuData(res.menuData,res.suiteData),res&&funCallback&&funCallback()}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取菜单数据!<br>Url:"+url)})}};getData()},this.getPicData=function(funCallback){if($ionicLoading.show({template:"正在加载图片数据..."}),angular.isArray(serviceUtils.picData)&&serviceUtils.picData.length>0)serviceLog.print("从缓存中加载图片数据..."),$ionicLoading.hide(),funCallback&&funCallback(serviceUtils.picData);else if(serviceConfig.test){var url="test/test-data/hots-v2_test.json?v=14";$timeout(function(){$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("T_GetPicData Response:",data),serviceConfig.picDataVersion=data.version,serviceUtils.picData.append(data.data),serviceConfig.picDataVersion===serviceConfig.constDefine.PIC_DATA_V2?funCallback(serviceUtils.picData):(angular.forEach(serviceUtils.picData,function(v,index){v.index_t=index+1+"/"+serviceUtils.picData.length,1===v.isTpl||"1"===v.isTpl?v.imgPath=serviceConfig.themeDomain+v.imgPath:v.imgPath=serviceConfig.dicDomain+v.imgPath}),funCallback&&funCallback(serviceUtils.picData))}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取图片数据!<br>Url:"+url)})},1e3)}else{var url="http://wxcdn.yumstone.com/weixin/document/{0}/menus/release/{1}/{2}/hots.json?v={3}";url=url.format(serviceConfig.sellerId,serviceConfig.storeId,0,(new Date).valueOf()),serviceLog.print("GetPicData Url:",url),$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("GetPicData Response:",data),serviceConfig.picDataVersion=data.version,serviceUtils.picData.append(data.data),serviceConfig.picDataVersion===serviceConfig.constDefine.PIC_DATA_V2?funCallback&&funCallback(serviceUtils.picData):angular.forEach(serviceUtils.picData,function(v,index){v.index_t=index+1+"/"+serviceUtils.picData.length,1===v.isTpl||"1"===v.isTpl?v.imgPath=serviceConfig.themeDomain+v.imgPath:v.imgPath=serviceConfig.dicDomain+v.imgPath,funCallback&&funCallback(serviceUtils.picData)})}).error(function(){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:获取图片数据!<br>Url:"+url)})}},this.getSideDish=function(funCallback){if($ionicLoading.show({template:"正在加载配菜数据..."}),angular.isArray(serviceUtils.sideDish)&&serviceUtils.sideDish.length>0)serviceLog.print("从缓存中加载配菜数据..."),$ionicLoading.hide(),funCallback&&funCallback(serviceUtils.sideDish);else if(serviceConfig.test){var url="test/test-data/sidedish.json";$timeout(function(){$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("T_GetSideDish Response:",data),angular.isArray(serviceUtils.sideDish)&&(serviceUtils.sideDish.length=0),angular.forEach(data.menudata,function(v){serviceUtils.sideDish.append(v.menuitem)}),funCallback&&funCallback(serviceUtils.sideDish)}).error(function(){$ionicLoading.hide(),serviceLog.print("T_GetSideDish Response:网络错误:获取配菜!<br>Url:"+url)})},1e3)}else{var url="{0}/document/{1}/menus/release/{2}/{3}/peicaidata.json?v={4}".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId,0,(new Date).valueOf());serviceLog.print("GetSideDish Url:",url),$http.get(url).success(function(data){serviceLog.print("GetSideDish Response:",data),$ionicLoading.hide(),angular.isArray(serviceUtils.sideDish)&&(serviceUtils.sideDish.length=0),angular.forEach(data.menudata,function(v){serviceUtils.sideDish.append(v.menuitem)}),funCallback&&funCallback(serviceUtils.sideDish)}).error(function(){$ionicLoading.hide()})}},this.getStoreName=function(funCallback){$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取门店名称...'});var url="{0}/wxmenusetup/v2/store.html?sellerid={1}&storeid={2}".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId);serviceLog.print("getStoreName:URL",url),serviceConfig.test?$timeout(function(){$http.get("test/test-data/storename.json?v=17").success(function(data){$ionicLoading.hide(),serviceLog.print("T_getStoreName Res:",data);var rd=parserRes(data);rd&&funCallback&&funCallback(rd)}).error(function(data){$ionicLoading.hide(),Dialog.showError("温馨提示","网络错误:获取门店名称")})},1e3):$http.get(url).success(function(data){$ionicLoading.hide(),serviceLog.print("getStoreName Res:",data);var rd=parserRes(data);rd&&funCallback&&funCallback(rd)}).error(function(data){$ionicLoading.hide(),Dialog.showError("温馨提示","网络错误:获取门店名称")})},this.clearOrder=function(funCallback){var url="http://{0}/onlineorder/clearorder/{1}.do".format(serviceConfig.orderDomain,serviceConfig.tableNum);serviceLog.print("清除菜品明细:URL",url),serviceConfig.test?$timeout(function(){$http.get("test/test-data/havegroupon.json?v=17").success(function(data){serviceLog.print("清除菜品明细 Res:",data);var rd=parserRes(data);rd&&funCallback&&funCallback(rd)})},1e3):$http.post(url).success(function(data){if(serviceLog.print("清除菜品明细 Res:",data),0==data.resultNumber){var rd=parserRes(data);rd&&funCallback&&funCallback(rd)}})},this.isHaveGroupon=function(funCallback){var url="{0}/salecoupon/{1}/{2}/ishavegroupon.html".format(serviceConfig.dicDomain,serviceConfig.sellerId,serviceConfig.storeId);serviceLog.print("获取是否有团购劵活动:URL",url),
serviceConfig.test?$timeout(function(){$http.get("test/test-data/havegroupon.json?v=17").success(function(data){serviceLog.print("T_获取是否有团购劵活动 Res:",data);var rd=parserRes(data);rd&&funCallback&&funCallback(rd)})},1e3):$http.get(url).success(function(data){if(serviceLog.print("获取是否有团购劵活动 Res:",data),0==data.resultNumber){var rd=parserRes(data);rd&&funCallback&&funCallback(rd)}})},this.addPreFood=function(data,callback){var url="{0}/onlineorder/{1}/preorder.html".format(serviceConfig.dicDomain,serviceConfig.sellerId);if(console.log("添加预点菜 URL"+url),serviceLog.print("添加预点菜 data:",data),serviceConfig.test){var url="test/test-data/response.json";$http.get(url).success(function(res){serviceLog.print("添加预点菜 resData",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){Dialog.showAlert("温馨提示","网络错误:添加菜品！")})}else $http.post(url,data).success(function(res){serviceLog.print("添加预点菜 resData",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){Dialog.showAlert("温馨提示","网络错误:添加菜品！")})},this.updatePreFoodNum=function(data,callback){var url="{0}/onlineorder/{1}/preorder.html".format(serviceConfig.dicDomain,serviceConfig.sellerId);if(console.log("修改预点菜数量 URL:"+url),serviceLog.print("修改预点菜数量 reqData:",data),serviceConfig.test){var url="test/test-data/response.json";$http.get(url).success(function(res){serviceLog.print("修改预点菜数量 resData:",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){Dialog.showAlert("温馨提示","网络错误:修改菜品数量！")})}else $http.put(url,data).success(function(res){serviceLog.print("修改预点菜数量 resData:",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){Dialog.showAlert("温馨提示","网络错误:修改菜品数量！")})},this.getPreFood=function(callback,istrue){var url="{0}/onlineorder/{1}/preorder.html".format(serviceConfig.dicDomain,serviceConfig.sellerId);if(console.log("获取预点菜 URL:"+url),console.log("获取预点菜 URL:"+!0),istrue&&$ionicLoading.show({template:'<ion-spinner icon="lines"></ion-spinner><br/>正在获取预点单...'}),serviceConfig.test){var url="test/test-data/pre-ordered.json?v=1";$http.get(url).success(function(res){$ionicLoading.hide(),console.log("获取预点菜 resData:",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){$ionicLoading.hide()})}else $http.get(url).success(function(res){$ionicLoading.hide(),console.log("获取预点菜 resData:",res),0==res.resultNumber&&callback&&callback(res.resultObject)}).error(function(res){$ionicLoading.hide()})},this.delPreFood=function(callback){var url="{0}/onlineorder/{1}/preorder.html".format(serviceConfig.dicDomain,serviceConfig.sellerId);if(console.log("删除预点菜菜品数据 URL:"+url),serviceConfig.test){var url="test/test-data/billstate.json?v=1";$http.get(url).success(function(res){$ionicLoading.hide(),console.log("删除预点菜菜品数据 resData:",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){$ionicLoading.hide(),Dialog.showAlert("温馨提示","网络错误:删除预点菜菜品数据！")})}else $http({method:"DELETE",url:url}).success(function(res){$ionicLoading.hide(),console.log("删除预点菜菜品数据 resData:",res);var _d=parserRes(res);_d&&callback&&callback(_d)}).error(function(res){$ionicLoading.hide()})}}),app.service("LoginModal",function($ionicModal,$rootScope,$state,serviceHttp,serviceConfig,serviceLog){"use strict";var _modal,_fun,_scope=$rootScope.$new();_scope.user={userid:"",password:""},$ionicModal.fromTemplateUrl("tml/login.htm",{scope:_scope,animation:"slide-in-up"}).then(function(modal){_modal=modal,_scope.bnCancel=function(){_modal.hide()},_scope.bnOk=function(){_modal.hide(),serviceHttp.login(_scope.user.userid,_scope.user.password,function(){serviceLog.print("UserInfor:",_scope.user),serviceConfig.waiter=_scope.user.userid,serviceConfig.ascode=_scope.user.password,_fun&&_fun()})}}),this.show=function(funcallback){_fun=funcallback,_modal.show()},this.hide=function(){_modal.hide()}}),app.service("serviceUtils",function($interval,$rootScope,$window,serviceLog,Dialog,serviceConfig){"use strict";this.menuData=[],this.picData=[],this.sideDish=[],this.saleoutData=[],this.billData=[],this.orderedTotal={count:0,amount:0,qty:0};var findType=function(bd,type){if(angular.isArray(bd))for(var i=0;i<bd.length;++i)if(1==type.isGroup){if(1==bd[i].isGroup)return bd[i]}else if(type.code===bd[i].code)return bd[i];return!1},findItem=function(bdItem,sItem){if(angular.isArray(bdItem))for(var i=0;i<bdItem.length;++i)if(bdItem[i].code==sItem.code)return!0;return!1};this.calculateCarTotal=function(){var _data=this.billData,_amount=0,_count=0,_qty=0;serviceLog.print("bill data:",_data),angular.forEach(_data,function(typeItem){_count+=typeItem.menuItem.length||0,0===typeItem.isGroup?angular.forEach(typeItem.menuItem,function(item){serviceLog.print("item utils+nosuit",item),_qty+=item.num,_amount+=item.num*item.price,angular.forEach(item.menuItem,function(v){_amount+=v.num*v.price})}):angular.forEach(typeItem.menuItem,function(item){_qty+=item.num,_amount+=item.num*item.price})}),this.orderedTotal.count=_count,this.orderedTotal.amount=Math.round(100*_amount)/100,this.orderedTotal.qty=_qty},this.calculateTypeNum=function(){var _originData=this.menuData,_bd=this.billData;serviceLog.print("_originData:",_originData),serviceLog.print("_bd:",_bd),angular.forEach(_originData,function(originTypeItem){var _type=findType(_bd,originTypeItem);serviceLog.print("_type:",_type),_type?(originTypeItem.num=_type.menuItem.length,angular.forEach(originTypeItem.menuItem,function(oItem){var _res=findItem(_type.menuItem,oItem);_res?oItem.num=1:oItem.num=0})):(angular.forEach(originTypeItem.menuItem,function(oItem){oItem.num=0}),originTypeItem.num=0)})};var findSuiteData=function(item,sd,newType){angular.forEach(sd,function(oSuite){oSuite.code===item.code&&(oSuite.picMode=item.picMode,oSuite.picPath=item.picPath,oSuite.iconPath=item.iconPath,oSuite.desc=item.desc,newType.menuItem.push(oSuite))})},findUsefulMenuData=function(pd,md,sd){var _usefullData=[];return angular.forEach(pd,function(_typeItem){if(0===_typeItem.isGroup){var _newType={code:_typeItem.code,name:"",isGroup:0,sndname:"",menuItem:[]};angular.forEach(_typeItem.menuItem,function(_item){findMenuData(_typeItem,_item,md,_newType)}),_newType.menuItem.length>0&&_usefullData.push(_newType)}else{var _newType={code:"999999",name:"menu",isGroup:1,sndname:"Suite",menuItem:[]};angular.forEach(_typeItem.menuItem,function(_item){findSuiteData(_item,sd,_newType)}),_newType.menuItem.length>0&&_usefullData.push(_newType)}}),_usefullData},doMenuDataV2=function(md,menuItems){!angular.isArray(md)||md.length<=0||angular.forEach(md,function(menuItem){var _newItem={code:menuItem.code,name:menuItem.name,sndname:menuItem.sndname,price:1*menuItem.price,memberprice:1*menuItem.memberprice,standard:menuItem.standard,standards:menuItem.standards,picMode:menuItem.picMode,picPath:menuItem.picPath,iconPath:menuItem.iconPath,memoflag:menuItem.memoflag,desc:menuItem.desc,memo:menuItem.memo,remark:[]};if(menuItem.memo&&menuItem.memo.indexOf("|")>=0){var remarks=menuItem.memo.split("|");angular.forEach(remarks,function(item){if(item.indexOf("@")>0){var _d=item.split("@"),_o={name:_d[0]||"",price:_d[1]||0,mark:_d[2]||0,code:_d[3]||""};_newItem.remark.push(_o)}else{var _o={name:item,price:0,mark:0,code:""};_newItem.remark.push(_o)}})}else if(menuItem.memo){var remarks=menuItem.memo.split("|");angular.forEach(remarks,function(item){if(item.indexOf("@")>0){var _d=item.split("@"),_o={name:_d[0]||"",price:_d[1]||0,mark:_d[2]||0,code:_d[3]||""};_newItem.remark.push(_o)}else{var _o={name:item,price:0,mark:0,code:""};_newItem.remark.push(_o)}})}menuItems.push(_newItem)})},doSuiteDataV2=function(sd,suites){!angular.isArray(sd)||sd.length<=0||angular.forEach(sd,function(suite){var _suite={code:suite.code,name:suite.name,sndname:suite.sndname,price:0,standard:suite.standard,memberNo:suite.memberNo,group:[],picMode:suite.picMode,picPath:suite.picPath,iconPath:suite.iconPath,desc:suite.desc};angular.forEach(suite.menuitem,function(suiteItem){1==suiteItem.selectflag&&(_suite.price+=suiteItem.price*(suiteItem.num||1));var _groupItem,_isFind=!1;angular.forEach(_suite.group,function(_sg){_isFind||_sg.groupNo!==suiteItem.groupNo||(_isFind=!0,_groupItem=_sg)});var _suiteItem={code:suiteItem.code,name:suiteItem.name,price:1*suiteItem.price,memberprice:1*suiteItem.memberprice,sndname:suiteItem.sndname,standard:suiteItem.standard,memberNo:suiteItem.memberNo,selectflag:suiteItem.selectflag,num:suiteItem.num};if(_isFind)_groupItem.suiteItem.push(_suiteItem);else{var _group={count:0,groupName:suiteItem.groupName,groupNo:suiteItem.groupNo,suiteItem:[]};_group.suiteItem.push(_suiteItem),_suite.group.push(_group)}}),suites.push(_suite)})},checkIsAdded=function(searchItem,mergeItems){var isFind=!1;return angular.forEach(mergeItems,function(item){searchItem.code===item.code?(item.standards.push({standard:searchItem.standard,price:searchItem.price,isSelect:!1,memberprice:searchItem.memberprice}),isFind=!0):isFind=!1}),isFind},findMenuData=function(type,item,md,newType){angular.forEach(md,function(oTypeItem){oTypeItem.code===type.code&&(newType.name=oTypeItem.name,newType.sndname=oTypeItem.ename||oTypeItem.name,angular.forEach(oTypeItem.menuitem,function(oItem){item.code===oItem.code&&(checkIsAdded(oItem,newType.menuItem)||(oItem.picMode=item.picMode,oItem.picPath=item.picPath,oItem.iconPath=item.iconPath,oItem.desc=item.desc,oItem.standards=[{standard:oItem.standard,price:oItem.price,isSelect:!0,memberprice:oItem.memberprice}],newType.menuItem.push(oItem)))}))})},findUsefulMenuData=function(pd,md,sd){var _usefullData=[];return angular.forEach(pd,function(_typeItem){if(0===_typeItem.isGroup){var _newType={code:_typeItem.code,name:"",isGroup:0,sndname:"",menuItem:[]};angular.forEach(_typeItem.menuItem,function(_item){findMenuData(_typeItem,_item,md,_newType)}),_newType.menuItem.length>0&&_usefullData.push(_newType)}else{var _newType={code:"999999",name:"menu",isGroup:1,sndname:"Suite",menuItem:[]};angular.forEach(_typeItem.menuItem,function(_item){findSuiteData(_item,sd,_newType)}),_newType.menuItem.length>0&&_usefullData.splice(0,0,_newType)}}),_usefullData},doNewDataV2=function(usefullData,_newData){angular.forEach(usefullData,function(typeItem){if(0===typeItem.isGroup){var _newType={code:typeItem.code,name:typeItem.name,isGroup:0,sndname:typeItem.sndname,menuItem:[]};doMenuDataV2(typeItem.menuItem,_newType.menuItem),angular.isArray(_newData)&&_newData.push(_newType)}else if(1===typeItem.isGroup){var _newType={code:typeItem.code,name:typeItem.name,isGroup:1,sndname:typeItem.sndname,menuItem:[]};doSuiteDataV2(typeItem.menuItem,_newType.menuItem),angular.isArray(_newData)&&_newData.push(_newType)}})};this.createMenuData=function(menuData,suiteData){if(this.menuData.length>0&&this.menuData.splice(0,this.menuData.length),serviceConfig.version===serviceConfig.versions){var _usefullData=findUsefulMenuData(this.picData,menuData,suiteData);doNewDataV2(_usefullData,this.menuData)}this.setMenuCache(angular.toJson(this.menuData))},this.getMenuVersionCache=function(){return this.getcache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_VER)},this.setMenuVersionCache=function(cacheVer){this.setcache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_VER,cacheVer)},this.removeMenuVersionCache=function(){this.removecache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_VER)},this.getMenuCache=function(){return this.getcache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_KEY)},this.setMenuCache=function(menuCacheData){this.setcache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_KEY,menuCacheData)},this.removeMenuCache=function(){this.removecache(serviceConfig.sellerId+serviceConfig.storeId+serviceConfig.constDefine.LOCAL_MENU_KEY)},this.appendNoSuiteData=function(type,item){var _bd=this.billData;serviceLog.print("B No Suite Ordered Data:"+_bd);var _type=findType(_bd,type);_type?_type.menuItem.push(item):(type.menuItem=[],type.menuItem.push(item),_bd.push(type)),this.calculateCarTotal(),this.calculateTypeNum(),serviceLog.print("No Suite Ordered Data:",_bd)},this.appendSuiteData=function(item){var _bd=this.billData,type={isGroup:1},_type=findType(_bd,type);_type?_type.menuItem.push(item):(type.menuItem=[],type.menuItem.push(item),_bd.push(type)),this.calculateCarTotal(),this.calculateTypeNum(),serviceLog.print("Suite Ordered Data:",_bd)},this.setcache=function(key,value){localStorage.setItem(key,value)},this.getcache=function(key){return localStorage.getItem(key)},this.removecache=function(key){localStorage.removeItem(key)},this.changeTitle=function(title){var $body=$("body");document.title=title;var $iframe=$("<iframe></iframe>");$iframe.on("load",function(){setTimeout(function(){$iframe.off("load").remove()},0)}).appendTo($body)}}),app.directive("noScroll",function($document){"use strict";return{restrict:"A",link:function($scope,$element,$attr){$document.on("touchmove",function(e){e.preventDefault()})}}}),app.factory("NosuiteView",function($ionicBody,$rootScope,$compile,$ionicTemplateLoader,$ionicBackdrop,$timeout,serviceConfig,AppData,serviceHttp,Dialog,serviceLog){"use strict";function init(){self.scope=$rootScope.$new(),self.isShow=!1,$ionicTemplateLoader.load("tml/tml-nosuite.htm").then(function(templateString){self.element=angular.element(templateString),$ionicBody.get().appendChild(self.element[0]),$compile(self.element)(self.scope),angular.extend(self.scope,{name:"",price:0,standard:"",standardItems:[],remarks:[],remarkQty:1,qty:1,isCallSideDish:!1,showSideDish:!1,sideDishes:[],bnCancelClick:function(){_funCancelCallback&&_funCancelCallback(),_close()},bnOkClick:function(){self.scope.isCallSideDish?(self.scope.showSideDish=!0,loadSideDish()):(doOk(),_funOkCallback&&_funOkCallback(),_close(!0))},sdBnCancelClick:function(){_funCancelCallback&&_funCancelCallback(),_close()},sdBnOkClick:function(){doOk(),_funOkCallback&&_funOkCallback(),_close()},bnMinusClick:function(){self.scope.qty>1&&self.scope.qty--},bnPlusClick:function(){self.scope.isCallSideDish?Dialog.showAlert("温馨提示","该菜可选配菜，主菜只能为1份！"):self.scope.qty++},checkStdSelect:function(item){if(!item.isSelect){for(var i=0;i<self.scope.standardItems.length;++i)for(var j=0;j<3;++j)self.scope.standardItems[i][j]&&(self.scope.standardItems[i][j].isSelect=!1);item.isSelect=!0,self.scope.price=item.price,self.scope.standard=item.standard}},classStdSelected:function(item){return item&&item.isSelect?"selected":""},checkRemarkSelect:function(item){item.price>0?(self.scope.remarkQty=1,Dialog.showTemplateConfirm({title:'<img src="imgs/logo-b.svg" class="img-logo">请输入数量',template:'<div class="qty-wrapper margin-top-10"><div class="row qty"><div class="col col-25 minus" ng-click="remarkQtyMinus()"><i class="ion-minus-round"></i></div><div class="col col-50 qty-text">{{remarkQty}}</div><div class="col col-25 plus" ng-click="remarkQtyAdd()"><i class="ion-plus-round"></i></div></div></div>',okText:"确定",okType:"button-df ion-checkmark-round",cancelText:"取消",cancelType:"button-df ion-close-round",scope:self.scope},function(){item.qty=self.scope.remarkQty,item.qty>0?item.isSelect=!0:item.isSelect=!1}),self.scope.remarkQtyMinus=function(){self.scope.remarkQty>=1&&self.scope.remarkQty--},self.scope.remarkQtyAdd=function(){self.scope.remarkQty++}):item.isSelect=!item.isSelect},sideDishClick:function(sideDishe){self.scope.remarkQty=1,Dialog.showTemplateConfirm({title:'<img src="imgs/logo-b.svg" class="img-logo">请输入数量',template:'<div class="qty-wrapper margin-top-10"><div class="row qty"><div class="col col-25 minus" ng-click="sideDishQtyMinus()"><i class="ion-minus-round"></i></div><div class="col col-50 qty-text">{{remarkQty}}</div><div class="col col-25 plus" ng-click="sideDishQtyAdd()"><i class="ion-plus-round"></i></div></div></div>',okText:"确定",okType:"button-df ion-checkmark-round",cancelText:"取消",cancelType:"button-df ion-close-round",scope:self.scope},function(){sideDishe.qty=self.scope.remarkQty}),self.scope.sideDishQtyMinus=function(){self.scope.remarkQty>=1&&self.scope.remarkQty--},self.scope.sideDishQtyAdd=function(){self.scope.remarkQty++}},classRemarkSelected:function(item){return item.isSelect?"selected":""}})})}function slideInUp(){self.element.addClass("nosuite-wrap-showing"),self.element[0].style.webkitTransformOrigin="center bottom 0px",self.element[0].style.top=window.innerHeight+"px",self.element[0].style[ionic.CSS.TRANSFORM]="translateY(-"+self.element[0].clientHeight+"px)",self.element[0].style.webkitTransition="-webkit-transform 0.2s linear"}function slideOutDown(){self.element[0].style[ionic.CSS.TRANSFORM]="translateY("+self.element[0].clientHeight+"px)",self.element[0].style.webkitTransition="-webkit-transform 0.2s linear",$timeout(function(){self.element.removeClass("nosuite-wrap-showing")},200)}function scaleToRB(){self.element[0].style.webkitTransformOrigin=window.innerWidth+"px bottom 0px",self.element[0].style[ionic.CSS.TRANSFORM]="scale(0.01,1)",self.element[0].style.webkitTransition="-webkit-transform 0.3s linear",$timeout(function(){self.element.removeClass("nosuite-wrap-showing"),self.element[0].style[ionic.CSS.TRANSFORM]="scale(1,1)"},300)}function doOk(){doOreredNoSuiteFood(),AppData.orderQty=AppData.orderQty+self.scope.qty,serviceLog.print("Ordered NoSuitefoodItemData:",orderedFood),serviceHttp.addFood(orderedFood)}function doOreredNoSuiteFood(){var i,j,rowData,menuItem={};for(i=0;i<self.scope.standardItems.length;++i){rowData=self.scope.standardItems[i];var isFind=!1;for(j=0;j<rowData.length;++j)if(rowData[j].isSelect){menuItem.code=rowData[j].code,menuItem.name=rowData[j].name,menuItem.standard=rowData[j].standard,menuItem.price=rowData[j].price,menuItem.num=self.scope.qty,isFind=!0;break}if(isFind)break}var remarks=[],remarksWithPrice=[];for(i=0;i<self.scope.remarks.length;++i)for(rowData=self.scope.remarks[i],j=0;j<rowData.length;++j)if(rowData[j].isSelect&&rowData[j].price<=0)remarks.push(rowData[j].name);else if(rowData[j].isSelect&&rowData[j].price>0){var remarkWithPrice={code:rowData[j].code,name:rowData[j].name,price:rowData[j].price,standard:rowData[j].standard,num:rowData[j].qty};remarksWithPrice.push(remarkWithPrice)}for(i=0;i<self.scope.sideDishes.length;++i)for(rowData=self.scope.sideDishes[i],j=0;j<rowData.length;++j)if(rowData[j].qty>0){var sd={code:rowData[j].code,name:rowData[j].name,price:rowData[j].price,standard:rowData[j].standard,num:rowData[j].qty};remarksWithPrice.push(sd)}menuItem.uid=serviceConfig.getUid(),menuItem.memo=remarks.toString(),menuItem.menuItem=remarksWithPrice,menuItem.timestamp=(new Date).valueOf(),orderedFood.num=menuItem.num,orderedFood.menuItem=menuItem,orderedFood.cost=menuItem.num*menuItem.price,orderedFood.isGroup=0}function loadData(itemCode){var foodType=AppData.getMenuItemData(itemCode);return serviceLog.print("foodType:",foodType),!!foodType&&(orderedFood.code=foodType.code,orderedFood.name=foodType.name,foodType.menuItems)}function _show(itemCode,funOkCallback,funCancelCallback){orderedFood={};var menuItemData=loadData(itemCode);return menuItemData?(_funOkCallback=funOkCallback,_funCancelCallback=funCancelCallback,$ionicBackdrop.retain(),self.isShow=!0,slideInUp(),self.scope.remarkQty=1,self.scope.qty=1,self.scope.isCallSideDish=!1,self.scope.showSideDish=!1,self.scope.sideDishes.length=0,loadStandrads(menuItemData),void loadRemarks(menuItemData)):(Dialog.showAlert("温馨提示","该菜品不存在！"),!1)}function _close(isOk){self.isShow&&($ionicBackdrop.release(),self.isShow=!1,isOk?scaleToRB():slideOutDown())}function loadStandrads(menuItemData){if(angular.isArray(menuItemData)&&menuItemData.length>0){self.scope.name=menuItemData[0].name,self.scope.price=menuItemData[0].price,self.scope.standard=menuItemData[0].standard,self.scope.standardItems=[],angular.isUndefined(menuItemData[0].memoflag)||("0"===menuItemData[0].memoflag||0===menuItemData[0].memoflag?self.scope.isCallSideDish=!1:"1"!==menuItemData[0].memoflag&&1!==menuItemData[0].memoflag||(self.scope.isCallSideDish=!0));for(var rowCount=0,i=0;i<menuItemData.length;++i){menuItemData[i].isSelect=!1;var row=[];row[0]=menuItemData[i],i++,i<menuItemData.length&&(menuItemData[i].isSelect=!1,row[1]=menuItemData[i]),i++,i<menuItemData.length&&(menuItemData[i].isSelect=!1,row[2]=menuItemData[i]),self.scope.standardItems[rowCount]=row,rowCount++}self.scope.standardItems[0][0].isSelect=!0}}function loadRemarks(menuItemData){if(angular.isArray(menuItemData)&&0!==menuItemData.length&&"0"!==menuItemData.length){self.scope.remarks=[];for(var rowCount=0,remarks=menuItemData[0].memo,i=0;i<remarks.length;++i){var row=[];angular.isNumber(remarks[i].price)||(remarks[i].price=Number(remarks[i].price)),remarks[i].qty=0,row[0]=remarks[i],row[0].isSelect=!1,i++,i<remarks.length&&(angular.isNumber(remarks[i].price)||(remarks[i].price=Number(remarks[i].price)),remarks[i].qty=0,row[1]=remarks[i],row[1].isSelect=!1),i++,i<remarks.length&&(angular.isNumber(remarks[i].price)||(remarks[i].price=Number(remarks[i].price)),remarks[i].qty=0,row[2]=remarks[i],row[2].isSelect=!1),self.scope.remarks[rowCount]=row,rowCount++}}}function loadSideDish(){var sd=AppData.getLocalSideDishData();if(angular.isArray(sd))for(var i=0;i<sd.length;++i){for(var row=[],j=0;j<3;++j)i<sd.length&&(row.push({code:sd[i].code,name:sd[i].name,standard:sd[i].standard,price:sd[i].price}),i++);i--,self.scope.sideDishes.push(row)}}var _funOkCallback,_funCancelCallback,self={},orderedFood={};return init(),{show:_show,close:_close}}),app.factory("SuiteView",function($ionicBody,$rootScope,$compile,$ionicTemplateLoader,$ionicBackdrop,$ionicScrollDelegate,$timeout,AppData,serviceHttp,Dialog,serviceConfig,serviceLog){"use strict";function init(){self.scope=$rootScope.$new(),self.isShow=!1,$ionicTemplateLoader.load("tml/tml-suite.htm").then(function(templateString){self.element=angular.element(templateString),$ionicBody.get().appendChild(self.element[0]),$compile(self.element)(self.scope),angular.extend(self.scope,{type:"",count:0,currentCount:0,name:"",showDetail:!1,item:[],price:0,qty:1,groups:[],checkSelect:function(item){angular.isObject(item)&&(self.scope.currentCount==self.scope.count?item.isSelect?(item.isSelect=!1,self.scope.currentCount--):(_lastSelectItem.isSelect=!1,item.isSelect=!0,_lastSelectItem=item):(item.isSelect=!item.isSelect,item.isSelect?(_lastSelectItem=item,self.scope.currentCount++):self.scope.currentCount--))},classselected:function(item){if(angular.isObject(item))return item.isSelect?"selected":""},classLeft:function(){return 0===_curIndex?"ion-arrow-return-left":"ion-arrow-left-c"},classRight:function(){return"ion-arrow-right-c"},bnBackClick:function(){0!==_bnSte&&3!==_bnSte?(_curIndex--,loadTypeData(_curIndex),_orderedSuiteData.groups.pop()):_close()},bnNextClick:function(){if(self.scope.count!=self.scope.currentCount){var text="您必须选择{0}份,请继续选择...".format(self.scope.count);return void Dialog.showAlert("警告",text)}3!=_bnSte&&2!=_bnSte?(addOrderedSuiteItem(),_curIndex++,loadTypeData(_curIndex),$ionicScrollDelegate.$getByHandle("menusuiteScroll").scrollTop()):(addOrderedSuiteItem(),_orderedSuiteData.uid=serviceConfig.getUid(),_orderedSuiteData.code=suiteData.code,_orderedSuiteData.name=suiteData.name,_orderedSuiteData.num=1,_orderedSuiteData.standard=suiteData.standard||"套",_orderedSuiteData.price=Math.floor(100*_suitePrice)/100,loadSuiteDetail(_orderedSuiteData),_orderedSuiteData={},self.scope.showDetail=!0)},bnMinusClick:function(){self.scope.qty>1&&self.scope.qty--},bnPlusClick:function(){self.scope.qty++},bnCancelClick:function(){_funCancelCallback&&_funCancelCallback(),_close()},bnOkClick:function(){doOk(),_funOkCallback&&_funOkCallback(),_close(!0)}})})}function slideInUp(){self.element.addClass("nosuite-wrap-showing"),self.element[0].style.webkitTransformOrigin="center bottom 0px",self.element[0].style.top=window.innerHeight+"px",self.element[0].style[ionic.CSS.TRANSFORM]="translateY(-"+self.element[0].clientHeight+"px)",self.element[0].style.webkitTransition="-webkit-transform 0.2s linear"}function slideOutDown(){self.element[0].style[ionic.CSS.TRANSFORM]="translateY("+self.element[0].clientHeight+"px)",self.element[0].style.webkitTransition="-webkit-transform 0.2s linear",$timeout(function(){self.element.removeClass("nosuite-wrap-showing")},200)}function scaleToRB(){self.element[0].style.webkitTransformOrigin=window.innerWidth+"px bottom 0px",self.element[0].style[ionic.CSS.TRANSFORM]="scale(0.01,1)",self.element[0].style.webkitTransition="-webkit-transform 0.3s linear",$timeout(function(){self.element.removeClass("nosuite-wrap-showing"),self.element[0].style[ionic.CSS.TRANSFORM]="scale(1,1)"},300)}function doOk(){suitefoodItemData.num=self.scope.qty,AppData.orderQty=AppData.orderQty+self.scope.qty,serviceLog.print("#########Ordered SuitefoodItemData:",suitefoodItemData);var suiteData=AppData.getSuiteHead();suiteData.menuItem={uid:suitefoodItemData.uid||"",code:suitefoodItemData.code||"",name:suitefoodItemData.name||"",num:suitefoodItemData.num||1,standard:suitefoodItemData.standard||"套",price:suitefoodItemData.price,menuItem:[]},angular.isArray(suitefoodItemData.groups)&&angular.forEach(suitefoodItemData.groups,function(v){suiteData.menuItem.menuItem.append(v.menuItems)}),serviceHttp.addFood(suiteData)}function loadSuiteDetail(sd){suitefoodItemData=sd,self.scope.name=sd.name,self.scope.price=sd.price,self.scope.qty=1,self.scope.groups=sd.groups}function loadTypeData(index){self.scope.type=suiteData.group[index].groupName,self.scope.count=suiteData.group[index].count,self.scope.currentCount=0,1==_suiteTypeCount?(self.scope.leftText="返回",self.scope.rightText="完成",_bnSte=3):0===_curIndex?(self.scope.leftText="返回",self.scope.rightText="下一步",_bnSte=0):_curIndex>=_suiteTypeCount-1?(self.scope.leftText="上一步",self.scope.rightText="完成",_bnSte=2):(self.scope.leftText="上一步",self.scope.rightText="下一步",_bnSte=1);var data=suiteData.group[index].suiteItem;if(self.scope.items=[],angular.isArray(data)){var c=0,_allSelect=!1;data.length==self.scope.count&&(_allSelect=!0,self.scope.currentCount=self.scope.count);for(var i=0;i<data.length;++i){var row=[];row[0]=data[i],row[0].groupName=self.scope.type,++i,i<data.length&&(row[1]=data[i],row[1].groupName=self.scope.type),self.scope.items[c]=row,c++;var j=0;if(_allSelect)for(j=0;j<row.length;++j)row[j].isSelect=!0;else for(j=0;j<row.length;++j)row[j].isSelect=!1}}}function addOrderedSuiteItem(){var group={};group.groupNo=suiteData.group[_curIndex].groupNo,group.groupName=self.scope.type,group.menuItems=[];for(var i=0;i<self.scope.items.length;++i)for(var rowData=self.scope.items[i],k=0;k<rowData.length;++k)if(rowData[k].isSelect){var suiteItem={};suiteItem.code=rowData[k].code,suiteItem.name=rowData[k].name,suiteItem.price=rowData[k].price,suiteItem.standard=rowData[k].standard,suiteItem.sgid=group.groupNo,suiteItem.num=Number(rowData[k].num),_suitePrice+=Number(suiteItem.price)*suiteItem.num,group.menuItems.push(suiteItem)}_orderedSuiteData.groups.push(group),console.log("addOrderedSuiteItem:",_orderedSuiteData.groups)}function _show(itemCode,funOkCallback,funCancelCallback){return(suiteData=AppData.getMenuSuiteItemData(itemCode))?(_funOkCallback=funOkCallback,_funCancelCallback=funCancelCallback,self.isShow=!0,_curIndex=0,_bnSte=0,_orderedSuiteData={},_orderedSuiteData.groups=[],_suitePrice=0,_lastSelectItem={},_suiteTypeCount=0,suitefoodItemData={},self.scope.showDetail=!1,$ionicBackdrop.retain(),slideInUp(),_suiteTypeCount=suiteData.group.length,self.scope.name=suiteData.name,void loadTypeData(_curIndex)):(Dialog.showAlert("温馨提示","该菜品不存在！"),!1)}function _close(isOk){self.isShow&&($ionicBackdrop.release(),self.isShow=!1,isOk?scaleToRB():slideOutDown())}var self={},suiteData={},_curIndex=0,_bnSte=0,_orderedSuiteData={};_orderedSuiteData.groups=[];var _suitePrice=0,_lastSelectItem={};console.log("suiteData:",suiteData);var _funOkCallback,_funCancelCallback,_suiteTypeCount=0,suitefoodItemData={};return init(),{show:_show,close:_close}}),app.service("serviceNoSuiteModal",function($ionicModal,$rootScope,$ionicScrollDelegate,$timeout,serviceLog,serviceUtils,serviceConfig,Dialog,serviceHttp){var _modal,_fun,_type,$scope=$rootScope.$new();$ionicModal.fromTemplateUrl("tml/nosuite-modal2.htm?v=20",{scope:$scope,animation:"slide-in-up"}).then(function(modal){_modal=modal,$scope.bnCancelClick=function(){_modal.hide()},$scope.menuItemMinus=function(){$scope.currentQty--,$scope.currentQty=Math.max(1,$scope.currentQty)},$scope.menuItemPlus=function(){$scope.currentQty++},$scope.bnOkClick=function(){var _isAddSide=!1,_sideDish=[],_nopriceRemark=[];angular.forEach($scope.menuItem.remark,function(remark){remark.choose&&(!remark.price||1*remark.price<=0?_nopriceRemark.push(remark.name):_sideDish.push({code:remark.code,name:remark.name,sndname:remark.sndname||"",standard:"",price:remark.price,num:remark.num,memo:""}))}),angular.forEach($scope.sideDishs,function(sideDish){sideDish.choose&&(_isAddSide=!0,_sideDish.push({code:sideDish.code,name:sideDish.name,sndname:sideDish.sndname||"",standard:sideDish.standard,price:sideDish.price,num:sideDish.num,memo:""}))});var checkSideDish=function(){1==$scope.menuItem.memoflag?_isAddSide?$scope.currentQty>1?Dialog.showAlert("温馨提示","该菜品您已经添加了配菜,主菜只能选择1份！",function(){$scope.currentQty=1,_fun&&_fun(_nopriceRemark.join(","),_sideDish,$scope,_type)}):_fun&&_fun(_nopriceRemark.join(","),_sideDish,$scope,_type):Dialog.showConfirm("温馨提示","该菜品可添加配菜,您尚未添加配菜！","去添加","不添加",function(){var v=document.getElementById("sidedish").offsetTop;$ionicScrollDelegate.$getByHandle("nosuite").scrollTo(0,v,!1)},function(){_fun&&_fun(_nopriceRemark.join(","),_sideDish,$scope,_type)}):_fun&&_fun(_nopriceRemark.join(","),_sideDish,$scope,_type)};angular.isArray($scope.menuItem.remark)&&$scope.menuItem.remark.length>0?_sideDish.length<=0&&_nopriceRemark.length<=0?Dialog.showConfirm("温馨提示","该菜品存在要求或做法！您是否添加?","去添加","不添加",function(){var v=document.getElementById("addmenu").offsetTop;serviceLog.print("id"+v),$ionicScrollDelegate.$getByHandle("nosuite").scrollTo(0,v,!1)},function(){checkSideDish()}):checkSideDish():(serviceLog.print("做法else"),checkSideDish())},$scope.standard=function(item){$scope.menuItem.standard=item.standard,$scope.menuItem.price=item.price,$scope.menuItem.memberprice=item.memberprice,serviceLog.print("规格",item)},$scope.sideDishClick=function(sideDish){sideDish.choose=!1,sideDish.num=0,Dialog.showSelectQty(sideDish,function(qty){serviceLog.print("Select Qty:"+qty),qty>0&&(sideDish.choose=!0,sideDish.num=qty)})},$scope.remarkClick=function(remark){!remark.price||1*remark.price<=0||(remark.num=0,remark.choose=!1,Dialog.showSelectQty(remark,function(qty){serviceLog.print("Select Qty:"+qty),qty>0&&(remark.choose=!0,remark.num=qty)}))}});var init=function(){console.log("--->",$scope.menuItem),angular.isArray($scope.sideDishs)&&angular.forEach($scope.sideDishs,function(sideDish){sideDish.choose=!1,sideDish.num=0}),angular.isArray($scope.menuItem.remark)&&angular.forEach($scope.menuItem.remark,function(remark){remark.choose=!1,remark.num=0}),angular.forEach($scope.menuItem.standards,function(standardItem){$scope.menuItem.standard===standardItem.standard&&($scope.data={choose:standardItem.standard})})},refresh=function(orderedNum){$ionicScrollDelegate.$getByHandle("nosuite").scrollTop(!1),$scope.currentQty=orderedNum||1,$scope.sideDishs=serviceUtils.sideDish,init()};this.show=function(menuItem,type,funCallback){$scope.picDomain=serviceConfig.getStaticResourceHead(),$scope.iconDomain=serviceConfig.themeDomain,$scope.menuItem=menuItem,_type=type,_fun=funCallback,_modal.show(),refresh(menuItem.orderedNum)},this.hide=function(){_modal.hide()}}),app.service("serviceSuiteModal",function($ionicModal,$rootScope,$ionicScrollDelegate,$timeout,serviceLog,serviceHttp,serviceConfig,serviceUtils,Dialog){var _modal,_fun,$scope=$rootScope.$new(),_suiteData={};$ionicModal.fromTemplateUrl("tml/suite-modal2.htm?v=9",{scope:$scope,animation:"slide-in-up"}).then(function(modal){
_modal=modal,$scope.bnCancelClick=function(){_modal.hide()},$scope.suitMinus=function(){$scope.currentQty--,$scope.currentQty=Math.max(1,$scope.currentQty)},$scope.suitPlus=function(){$scope.currentQty++},$scope.bnOkClick=function(){$scope.suiteData.num=$scope.suiteData.num?$scope.suiteData.num:0,$scope.suiteData.num=$scope.suiteData.num+$scope.currentQty;var suite={code:$scope.suiteData.code,name:$scope.suiteData.name,standard:$scope.suiteData.standard,price:$scope.suiteData.newprice||$scope.suiteData.price,memberprice:0,num:$scope.currentQty,memo:"",menuSuiteItem:[]},food={code:"999999",name:"menu",ename:"Suite",isGroup:1,menuItem:{uid:serviceConfig.getUid(),code:$scope.suiteData.code,name:$scope.suiteData.name,sndname:$scope.suiteData.sndname||"",standard:$scope.suiteData.standard,price:$scope.suiteData.newprice||$scope.suiteData.price,num:$scope.currentQty,memo:"",menuItem:[]}},isOk=!0,err="";angular.forEach($scope.suiteData.group,function(group){var c=0;if(angular.forEach(group.suiteItem,function(item){if(item.choose){c++;var suiteItem={code:item.code,name:item.name,sndname:item.sndname,standard:item.standard,price:item.price,memberprice:item.memberprice,num:item.num,memo:"",sgid:group.groupNo||"0"};suite.menuSuiteItem.push(suiteItem),food.menuItem.menuItem.push(suiteItem)}}),c!=group.count)return isOk=!1,void(err="{0}还差{1}份,请继续选择!".format(group.groupName,group.count-c))}),isOk?(_modal.hide(),_fun&&(serviceLog.print("servicesuitmodal>>>>>>>suite",suite),serviceLog.print("servicesuitmodal>>>>>>>food",food),_fun(food,suite))):Dialog.showAlert("温馨提示",err)},$scope.chooseChange=function(itemsuit,group,index){var lastIndex=0,count=0;angular.forEach(group.suiteItem,function(suiteitem,$index){suiteitem.choose&&(count++,index!=$index&&(lastIndex=$index))}),count>group.count&&(group.suiteItem[lastIndex].choose=!1,$scope.suiteData.newprice-=group.suiteItem[lastIndex].price*(group.suiteItem[lastIndex].num||1)),count<=group.count&&(group.needCount=group.count-count),itemsuit.choose?$scope.suiteData.newprice+=itemsuit.price*(itemsuit.num||1):$scope.suiteData.newprice-=itemsuit.price*(itemsuit.num||1)}});var refresh=function(orderedNum){$ionicScrollDelegate.$getByHandle("suite").scrollTop(!1),$scope.suiteData=_suiteData,$scope.currentQty=orderedNum||1,angular.forEach($scope.suiteData.group,function(group){var c=0;angular.forEach(group.suiteItem,function(item){item.choose=!1,"1"!==item.selectflag&&1!==item.selectflag||(item.choose=!0,c++)}),group.count=c})};this.show=function(suiteData,funCallback){$scope.picDomain=serviceConfig.getStaticResourceHead(),_suiteData=suiteData,_suiteData.newprice=suiteData.price,_fun=funCallback,_modal.show(),refresh(suiteData.orderedNum)},this.hide=function(){_modal.hide()}}),app.service("serviceOrderMemo",function($ionicModal,$rootScope,$ionicScrollDelegate,$timeout,serviceLog,serviceUtils,serviceConfig,Dialog,serviceHttp){var _modal,_type,_callback,$scope=$rootScope.$new();$ionicModal.fromTemplateUrl("tml/tml-ordermemo.htm?v=20",{scope:$scope,animation:"slide-in-up"}).then(function(modal){_modal=modal,$scope.bnCancelClick=function(){$scope.order.memo="",_modal.hide()},$scope.bnOkClick=function(){$scope.order.memo.length>8?Dialog.showAlert("温馨提示","不能超过8个字！"):(_callback(_type,$scope.order),_modal.hide())}}),this.show=function(menuItem,type,callback){$scope.order=menuItem,_type=type,_callback=callback,_modal.show()},this.hide=function(){_modal.hide()}}),app.controller("CtrlRoot",function($scope,$state,$rootScope,$stateParams,AppData,serviceUtils,LoginModal,serviceConfig,serviceLog,serviceHttp,Dialog){"use strict";$scope.tableNum="",$scope.orderCount=0,$scope.payOrderCount=0,$scope.actnum=0;var url="",chePayTypes=function(){return 1===serviceConfig.checkClient()&&serviceHttp.getPayTypes(function(payType){if(0===payType.weixinpay&&0===payType.wxmemberpay)return Dialog.showAlert("温馨提示","商家未开通微信支付，自助点菜功能将无法正常工作！"),!1}),!0};$scope.bnClickOrder=function(){if(chePayTypes()){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$scope.orderCount>0?$state.go("ordered",par):serviceConfig.picDataVersion===serviceConfig.constDefine.PIC_DATA_V2?$state.go("orderv2",par):$state.go("order",par)}};var getUrlVars=function(name){for(var hash,vars=[],hashes=window.location.href.slice(window.location.href.lastIndexOf("?")+1).split("&"),i=0;i<hashes.length;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars[name]};$scope.bnServerOrder=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("login",par)},$scope.pay=function(){if(chePayTypes()){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("pay",par)}},$scope.bnReg=function(){var url="{0}/{1}/vip/register.html".format(serviceConfig.dicDomain,serviceConfig.sellerId);window.location.href=url};var loadData=function(){serviceHttp.getPicData(function(){serviceHttp.getOriginMenuData(),serviceHttp.getSideDish()})},getStoreName=function(){serviceHttp.getStoreName(function(data){data&&serviceUtils.changeTitle(data.name)})},isHaveGroupon=function(){serviceHttp.isHaveGroupon(function(data){$scope.actnum=data.actnum,url=data.url,console.log("是否有团购劵活动",data)})};$scope.clickAct=function(){console.log(url),window.location.href=url};var refresh=function(){serviceHttp.getBillState(function(bill){$scope.orderCount=bill.orderCount,$scope.payOrderCount=bill.payOrderCount,0===bill.payOrderCount&&0===bill.payedCount&&(serviceConfig.cover=0)}),serviceConfig.clearWaiter()};$scope.$on("$ionicView.beforeEnter",function(){refresh()});var getPreOrdered=function(){var tempCodeFind={};serviceHttp.getSaleoutFromStore(function(saleout){angular.forEach(saleout,function(saleoutItem){tempCodeFind[saleoutItem.code]=saleoutItem.code})}),serviceHttp.getPreFood(function(res){console.log("获取预点菜返回???????????：",res.data),angular.forEach(res.data,function(type){angular.forEach(type.menuItem,function(item){if(tempCodeFind[item.code]!=item.code){var _type={code:type.code,isGroup:type.isGroup,name:type.name,ename:type.ename};_type.menuItem=item,serviceHttp.addFood(_type,function(){refresh()})}})}),res&&serviceHttp.delPreFood()})},init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.dogNum=getUrlVars("dog")||serviceConfig.dogNum,serviceLog.print("Dog:",serviceConfig.dogNum),""!=$stateParams.orderDomain&&(serviceConfig.orderDomain=$stateParams.orderDomain),$scope.tableNum=serviceConfig.tableNum,$scope.showError=!1,""===serviceConfig.getUid()?serviceHttp.createUidFromServer(function(uid){serviceConfig.setUid(uid),serviceLog.print("Create New Uid:",serviceConfig.getUid())}):serviceLog.print("LocalStorage Exist Uid:",serviceConfig.getUid()),serviceHttp.checkPay(!0,function(){$scope.payOrderCount=0,serviceConfig.cover=0,$scope.showError=!1},function(msg){$scope.showError=!0,$scope.errmsg=msg}),loadData(),isHaveGroupon(),getStoreName(),getPreOrdered()};init()}),app.controller("CtrlOrderV2",function($scope,$state,$stateParams,$ionicScrollDelegate,serviceUtils,serviceHttp,serviceLog,Dialog,serviceConfig,serviceSuiteModal,serviceNoSuiteModal,$timeout){"use strict";var yumstome=function(){$timeout(function(){$scope.yumstome=!0},3e3)};$scope.bnOrdered=function(){if($scope.ordered.qty<=0)Dialog.showAlert("温馨提示","您尚未点菜，请您先点菜！");else{var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("ordered",par)}},$scope.typeClick=function(item){var v=document.getElementById(item.code).offsetTop;$ionicScrollDelegate.$getByHandle("order-v2").scrollTo(0,v,!1)};var addDataToCar=function(nopriceRemark,remark,scope,_type){scope.menuItem.num=scope.menuItem.num?scope.menuItem.num:0,scope.menuItem.num=scope.menuItem.num+scope.currentQty;var _orderType={code:_type.code,name:_type.name,isGroup:0},_orderItem={code:scope.menuItem.code,name:scope.menuItem.name,sndname:scope.menuItem.sndname,price:scope.menuItem.price,memberprice:scope.menuItem.memberprice||"0",standard:scope.menuItem.standard,num:scope.currentQty,memo:nopriceRemark,menuItem:remark};serviceUtils.appendNoSuiteData(_orderType,_orderItem),serviceNoSuiteModal.hide(),_orderItem.uid=serviceConfig.getUid();var food={code:_type.code,name:_type.name,ename:_type.sndname||"",isGroup:0,menuItem:_orderItem};serviceHttp.addFood(food)},addSuiteDataToCar=function(food,suite){serviceHttp.addFood(food,function(res){res&&(serviceUtils.calculateTypeNum(),serviceUtils.calculateCarTotal())}),serviceUtils.appendSuiteData(suite)};$scope.bnDetail=function(item,type){item.num=item.num||0,serviceLog.print("bnDetail..."),item.isSaleout||(1===type.isGroup?(item.oderedNum=1,serviceSuiteModal.show(item,addSuiteDataToCar)):0===type.isGroup&&(item.oderedNum=1,1==item.memoflag?(serviceLog.print("have sidedish..."),serviceNoSuiteModal.show(item,type,addDataToCar)):angular.isArray(item.remark)&&item.remark.length>0?(serviceLog.print("have add menu..."),serviceNoSuiteModal.show(item,type,addDataToCar)):0!=item.picMode?serviceNoSuiteModal.show(item,type,addDataToCar):item.standards.length>1?serviceNoSuiteModal.show(item,type,addDataToCar):Dialog.showSelectQty(item,function(qty){item.num=qty;var _type={code:type.code,isGroup:0,name:type.name},_item={code:item.code,name:item.name,sndname:item.sndname,price:item.price,memberprice:item.memberprice||"0",standard:item.standard,num:qty,menuItem:[],memo:""};serviceUtils.appendNoSuiteData(_type,_item),_item.uid=serviceConfig.getUid();var food={code:type.code,name:type.name,ename:type.sndname||"",isGroup:0,menuItem:_item};serviceHttp.addFood(food)})))};var loadSaleOutData=function(){serviceHttp.getSaleoutFromStore(function(saleout){angular.forEach(serviceUtils.menuData,function(picItem){angular.forEach(picItem.menuItem,function(menuItem){angular.forEach(saleout,function(saleoutItem){if(menuItem.code===saleoutItem.code)return void(menuItem.isSaleout=!0)})})})})},loadOrginMenuData=function(){serviceHttp.getOriginMenuData(function(){$scope.types=serviceUtils.menuData,loadSaleOutData()})},loadPicData=function(){serviceHttp.checkResourceCache(function(){}),serviceHttp.getPicData(function(){loadOrginMenuData(),yumstome()})},loadSideDish=function(){serviceHttp.getSideDish()},refresh=function(){serviceUtils.calculateCarTotal(),serviceHttp.getOrderedFood(function(data){serviceUtils.billData.length=0,serviceUtils.billData.append(data.data||[]),serviceUtils.calculateTypeNum(),serviceUtils.calculateCarTotal()},!0)};$scope.$on("$ionicView.beforeEnter",function(){refresh()});var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.orderDomain=$stateParams.orderDomain,console.log("这是URl++++++++++++"+serviceConfig.getStaticResourceHead()),$scope.picDomain=serviceConfig.test?"":"http://wxcdn.yumstone.com/weixin/document/",loadPicData(),loadSideDish(),$scope.ordered=serviceUtils.orderedTotal,$scope.iconDomain=serviceConfig.themeDomain,serviceUtils.calculateCarTotal()};init()}),app.controller("CtrlOrder",function($scope,$ionicModal,$state,$stateParams,$rootScope,$timeout,$interval,AppData,Dialog,NosuiteView,SuiteView,$ionicScrollDelegate,serviceConfig,serviceHttp,serviceLog){"use strict";var createMenuType,refreshMenuTypeActive,_saleoutData=[],PageConfig={index:0,preSectionPageCount:5,pageIndexs:[],FRESH_TIME:300,pages:[]};$scope.moreDataCanBeLoaded=function(){var _lastIndex=PageConfig.pageIndexs[PageConfig.pageIndexs.length-1];return _lastIndex+1!==PageConfig.pages.length},$scope.loadPre=function(){var _firstIndex=PageConfig.pageIndexs[0];if(_firstIndex<=0)return void $scope.$broadcast("scroll.refreshComplete");var _lastIndex=PageConfig.pageIndexs[PageConfig.pageIndexs.length-1];PageConfig.index=_firstIndex-PageConfig.preSectionPageCount,PageConfig.index=Math.max(0,PageConfig.index),$timeout(function(){$scope.photos=[],PageConfig.pageIndexs=[];for(var i=PageConfig.index;i<=_lastIndex;++i)PageConfig.pageIndexs.push(i),$scope.photos.push(PageConfig.pages[i]);loadViewData();var _h=PageConfig.preSectionPageCount*window.innerHeight-80;$ionicScrollDelegate.$getByHandle("order.scroll").scrollTo(0,_h,!1),$scope.$broadcast("scroll.refreshComplete")},PageConfig.FRESH_TIME);var _code=PageConfig.pages[PageConfig.index].menuTypeId;refreshMenuTypeActive(_code)},$scope.loadMore=function(){PageConfig.pageIndexs.length>0&&(PageConfig.index=PageConfig.pageIndexs[PageConfig.pageIndexs.length-1],PageConfig.index++),$timeout(function(){loadData(),$scope.$broadcast("scroll.infiniteScrollComplete")},PageConfig.FRESH_TIME);var _code=PageConfig.pages[PageConfig.index].menuTypeId;refreshMenuTypeActive(_code)};var loadData=function(){for(var size=Math.min(PageConfig.index+PageConfig.preSectionPageCount,PageConfig.pages.length),i=PageConfig.index;i<size;++i)PageConfig.pageIndexs.push(i),$scope.photos.push(PageConfig.pages[i]),loadViewData()},moveTo=function(index){if(!(index<0)){var _index=index,_lastIndex=PageConfig.pageIndexs[PageConfig.pageIndexs.length-1],_firstIndex=PageConfig.pageIndexs[0];if(_index>_lastIndex)$scope.photos=[],PageConfig.pageIndexs=[],PageConfig.index=_index,loadData(),$ionicScrollDelegate.$getByHandle("order.scroll").scrollTop();else if(_index<_firstIndex)$scope.photos=[],PageConfig.pageIndexs=[],PageConfig.index=_index,loadData(),$ionicScrollDelegate.$getByHandle("order.scroll").scrollTop();else{var _top=(index-_firstIndex)*window.innerHeight;PageConfig.index=index,$ionicScrollDelegate.$getByHandle("order.scroll").scrollTo(0,_top,!1)}}},loadSaleOutData=function(){serviceHttp.getSaleoutFromStore(function(saleoutData){_saleoutData=saleoutData})};$scope.hotClick=function(data){return console.log("HotData:",data),data.isSaleout?void serviceLog.print("This food item sale out"):void(0===data.isGroup||"0"===data.isGroup?NosuiteView.show(data.code,function(){serviceLog.print("NosuiteView Order Ok..."+AppData.orderQty),$scope.orderedQty=AppData.orderQty}):1!==data.isGroup&&"1"!==data.isGroup||SuiteView.show(data.code,function(){serviceLog.print("SuiteView Order Ok..."+AppData.orderQty),$scope.orderedQty=AppData.orderQty}))},$scope.orderedClick=function(){if($scope.orderedQty>0){$scope.menuTypeShow=!1;var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};""===serviceConfig.waiter&&""===serviceConfig.ascode?$state.go("ordered",par):$state.go("server",par)}else Dialog.showAlert("温馨提示","您还未点菜,请先点菜!")},$scope.hideMenuType=function(){$scope.menuTypeShow=!1};var replacePrice=function(text,replace){var reg=new RegExp("<y-price>([^]+)</y-price>","g"),newstr=text.replace(reg,replace);return newstr},loadViewData=function(){angular.forEach($scope.photos,function(v){angular.forEach(v.hots,function(v1){v1.view&&angular.forEach(MenuData,function(v2){v1.isGroup==v2.isGroup&&angular.forEach(v2.menuitem,function(v3){if(v1.code==v3.code){var nv="{0}元/{1}".format(v3.price,v3.standard);v1.view=replacePrice(v1.view,nv)}})})})})},loadPicData=function(){$scope.photos=[],angular.isArray(AppData.getLocalPicData())&&AppData.getLocalPicData().length>0?(PageConfig.pages=AppData.getLocalPicData(),loadMenuTypeData(),loadData()):serviceHttp.getPicData(function(picData){PageConfig.pages=picData,loadMenuTypeData(),loadData()})};$scope.styleHot=function(pic,hot){var sw=window.innerWidth,sh=window.innerHeight,ow=0===pic.imgW?1:pic.imgW,oh=0===pic.imgH?1:pic.imgH,wr=1*sw/ow,hr=1*sh/oh,x=Math.floor(hot.x*wr),y=Math.floor(hot.y*hr),w=Math.floor(hot.w*wr),h=Math.floor(hot.h*hr),styleStr='{"top":"{0}px","left":"{1}px","width":"{2}px","height":"{3}px"}'.format(y,x,w,h),styleObj=JSON.parse(styleStr);return styleObj},$scope.styleSaleout=function(pic,hot){var str,sh=window.innerHeight,oh=0===pic.imgH?1:pic.imgH,hr=1*sh/oh,h=Math.floor(hot.h*hr);return str=h<=80?'{"height": "100%","width": "100%"}':'{"height": "50%","width": "50%"}',JSON.parse(str)},$scope.isSaleout=function(hot){for(var i=0;i<_saleoutData.length;++i)if(_saleoutData[i]==hot.code)return hot.isSaleout=!0,!0;return hot.isSaleout=!1,!1},createMenuType=function(md){var items=[];angular.forEach(PageConfig.pages,function(pic,pageIndex){if(angular.isArray(pic.hots)&&pic.hots.length>0){var item={};angular.forEach(md,function(v1){angular.forEach(v1.menuitem,function(v2){if(pic.hots[0].code==v2.code){var isFind=!1;item.typeName=v1.name,item.typeName||(item.typeName="未命名"),item.code=v1.code,item.pageIndex=pageIndex,angular.forEach(items,function(v){v.code==v1.code&&(isFind=!0)}),isFind||items.push(item)}})})}}),$scope.items=items,serviceLog.print("--->",$scope.items),$scope.items.length>0&&($scope.items[0].isActive=!0)};var MenuData=[],loadMenuTypeData=function(){angular.isArray(AppData.getLocalMenuData())&&AppData.getLocalMenuData().length>0?(MenuData=AppData.getLocalMenuData(),createMenuType(MenuData),loadViewData(MenuData)):serviceHttp.getMenuData(!0,function(md){serviceLog.print("李炳儒",md),MenuData=md,createMenuType(md),loadViewData(md)})},loadSideDish=function(){var sd=AppData.getLocalSideDishData();angular.isArray(sd)&&0!==sd.length||serviceHttp.getSideDish()};refreshMenuTypeActive=function(code){if($scope.items)for(var i=0;i<$scope.items.length;++i)$scope.items[i].isActive=!1,$scope.items[i].code==code&&($scope.items[i].isActive=!0)},$scope.menuTypeClick=function(item){refreshMenuTypeActive(item.code),moveTo(item.pageIndex)},$scope.classMenuTypeActive=function(item){return item.isActive?"item-active":""};var loadBillState=function(){serviceHttp.getBillState(function(bill){$scope.orderedQty=bill.orderCount,AppData.orderQty=bill.orderCount},!0)},init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain};init(),loadPicData(),loadSideDish(),loadSaleOutData(),loadBillState()}),app.controller("CtrlPay",function($scope,$state,$stateParams,serviceHttp,Dialog,serviceConfig,serviceLog){"use strict";var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,serviceHttp.getNoPayBill(function(data){serviceLog.print("未支付",data),angular.isObject(data.unpay)&&($scope.bill=data.unpay)})};$scope.bnGoPay=function(){serviceHttp.checkPay(!0);var res=serviceConfig.checkClient(),data={amount:$scope.bill.amount||0,clientType:res};serviceHttp.getPayTypes(function(payType){if(0===payType.alipay&&0===payType.weixinpay&&0===payType.wxmemberpay)Dialog.showAlert("温馨提示","该商户未设置任何支付方式！");else if(0===res){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,wxmemberpay:payType.wxmemberpay,orderDomain:serviceConfig.orderDomain};$state.go("qrcode",par)}else if(1===res)if(1===payType.wxmemberpay)serviceHttp.weixinMemberPay(function(res){var parm="&tableno={0}&orderdomain={1}&dog={2}".format(serviceConfig.tableNum,serviceConfig.orderDomain,serviceConfig.dogNum);window.location.href=res.url+parm});else if(1===payType.weixinpay&&0===payType.wxmemberpay){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("wxqrcode",par)}else 0===payType.weixinpay&&0===payType.wxmemberpay&&Dialog.showAlert("温馨提示","该商户未设置微信/微信会员支付！请使用支付宝扫一扫支付!");else 2===res&&(1===payType.alipay?Dialog.showPayClass("温馨提示",data,function(){serviceHttp.aliPay(function(res){window.location.href=res.url})}):Dialog.showAlert("温馨提示","该商户未设置支付宝支付！请使用微信扫一扫支付!"))})},init()}),app.controller("CtrlServer",function($scope,$state,$rootScope,$stateParams,$interval,serviceHttp,serviceConfig,Dialog,serviceLog){"use strict";var checkSaleout=function(orderedArray,saleoutArray){var check=function(isGroup,code,standard,call){angular.forEach(saleoutArray,function(item){0===isGroup?item.code===code&&item.standard===standard&&call():1===isGroup&&item.code===code&&call()})};if(!angular.isArray(orderedArray)||!angular.isArray(saleoutArray))return!1;var saleoutName=[];return angular.forEach(orderedArray,function(item,index0){0===item.isGroup?angular.forEach(item.menuItem,function(value,index1){check(0,value.code,value.standard,function(){saleoutName.push(value.name),serviceHttp.operateOrderFoodNum({orderid:value.orderid,uid:"",num:0})}),angular.forEach(value.menuItem,function(v,index2){check(0,v.code,v.standard,function(){saleoutName.push(v.name),serviceHttp.operateOrderFoodNum({orderid:v.orderid,uid:"",num:0})})})}):1===item.isGroup&&angular.forEach(item.menuItem,function(value,index1){check(1,value.code,value.standard,function(){saleoutName.push(value.name),serviceHttp.operateOrderFoodNum({orderid:value.orderid,uid:"",num:0})})})}),saleoutName.join()||!1},loadData=function(hideLoading){serviceLog.print("CtrlOrdered load data..."),serviceHttp.getOrderedFood(function(data){$scope.bill=[],$scope.bill=data},hideLoading)};$scope.bnRefresh=function(){loadData()},$scope.bnAddFood=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};serviceConfig.picDataVersion===serviceConfig.constDefine.PIC_DATA_V2?$state.go("orderv2",par):""===serviceConfig.picDataVersion?$state.go("root",par):$state.go("order",par)},$scope.bnMinus=function(food){serviceLog.print("Minus:",food),food.num--,food.num=Math.max(0,food.num);var _d={orderid:food.orderid,uid:"",num:food.num};serviceHttp.operateOrderFoodNum(_d)},$scope.bnAdd=function(food){serviceLog.print("Add:",food),food.num++,food.num=Math.min(20,food.num);var _d={orderid:food.orderid,uid:"",num:food.num};serviceHttp.operateOrderFoodNum(_d)},$scope.bnPostBill=function(){serviceHttp.getSaleoutFromStore(function(saleoutList){var res=checkSaleout($scope.bill.data,saleoutList);res?Dialog.showAlert("温馨提示","您点的菜品'{0}'已售完,系统将自动删除这些菜品!".format(res),function(){loadData()}):Dialog.showAlterPeople("输入人数",serviceConfig.tableNum,function(data){data.waiter=serviceConfig.waiter,data.ascode=serviceConfig.ascode,serviceHttp.order2bill(data,function(){Dialog.showAlert("温馨提示","您的订单已传送到厨房，请耐心等待!",function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)})})})})};var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,serviceConfig.setTimer($interval(function(){serviceLog.print("Timeout {0}ms,refresh!!".format(serviceConfig.refreshTime)),loadData(!0)},serviceConfig.refreshTime))};init(),loadData()}),app.controller("CtrlOrdered",function($scope,$state,$stateParams,$rootScope,serviceOrderMemo,$interval,serviceUtils,serviceNoSuiteModal,serviceHttp,serviceConfig,serviceLog,Dialog){"use strict";var checkSaleout=function(orderedArray,saleoutArray){var check=function(isGroup,code,standard,call){angular.forEach(saleoutArray,function(item){0===isGroup?item.code===code&&item.standard===standard&&call():1===isGroup&&item.code===code&&call()})};if(!angular.isArray(orderedArray)||!angular.isArray(saleoutArray))return!1;var saleoutName=[];return angular.forEach(orderedArray,function(item,index0){0===item.isGroup?angular.forEach(item.menuItem,function(value,index1){check(0,value.code,value.standard,function(){saleoutName.push(value.name),serviceHttp.operateOrderFoodNum({orderid:value.orderid,uid:"",num:0})}),angular.forEach(value.menuItem,function(v,index2){check(0,v.code,v.standard,function(){saleoutName.push(v.name),serviceHttp.operateOrderFoodNum({orderid:v.orderid,uid:"",num:0})})})}):1===item.isGroup&&angular.forEach(item.menuItem,function(value,index1){check(1,value.code,value.standard,function(){saleoutName.push(value.name),serviceHttp.operateOrderFoodNum({orderid:value.orderid,uid:"",num:0})})})}),saleoutName.join()||!1},loadData=function(hideLoading){serviceHttp.getOrderedFood(function(data){serviceUtils.billData=data.data||[],$scope.bill=[],$scope.bill=data},hideLoading)};$scope.bnRefresh=function(){loadData()};var updateOrderMemo=function(type,food){var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:0},_menuItem={code:type.code,name:type.name,ename:type.ename,isGroup:type.isGroup,menuItem:food};serviceHttp.operateOrderFoodNum(_d),serviceHttp.addFood(_menuItem,function(){serviceLog.print("添加套餐food",food),loadData()})};$scope.foodDetil=function(type,food){serviceOrderMemo.show(food,type,updateOrderMemo)},$scope.bnAddFood=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};serviceConfig.picDataVersion===serviceConfig.constDefine.PIC_DATA_V2?$state.go("orderv2",par):""===serviceConfig.picDataVersion?$state.go("root",par):$state.go("order",par)},$scope.bnMinus=function(food,$index){event.stopPropagation(),serviceLog.print("Minus:",food),food.num--,food.num=Math.max(0,food.num);var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:food.num};serviceHttp.operateOrderFoodNum(_d,function(){0==food.num&&(food.hide=1)})},$scope.bnAdd=function(food,type){if(event.stopPropagation(),0===type.isGroup&&angular.isArray(food.menuItem)&&food.menuItem.length>0)Dialog.showAlert("温馨提示","该菜有附加收费项目，请到点菜界面加菜!");else{food.num++,food.num=Math.min(20,food.num);var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:food.num};serviceHttp.operateOrderFoodNum(_d)}},$scope.bnPostBill=function(){serviceHttp.getSaleoutFromStore(function(saleoutList){var res=checkSaleout($scope.bill.data,saleoutList);res?Dialog.showAlert("温馨提示","您点的菜品'{0}'已售完,系统将自动删除这些菜品!".format(res),function(){loadData()}):serviceConfig.cover>0?serviceHttp.order2bill({cover:serviceConfig.cover,waiter:"",ascode:""},function(){Dialog.showAlert("温馨提示","您的订单已传送到厨房，请耐心等待!",function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)})},function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)}):Dialog.showAlterPeople("输入人数",serviceConfig.tableNum,function(data){serviceHttp.order2bill(data,function(){Dialog.showAlert("温馨提示","您的订单已传送到厨房，请耐心等待!",function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)})},function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)})})})},$scope.bnClear=function(){Dialog.showConfirm("温馨提示","你确定要清除全部菜品明细吗？","确定","取消",function(){serviceHttp.clearOrder(function(){loadData()})})};var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,serviceConfig.setTimer($interval(function(){serviceLog.print("Timeout {0}ms,refresh!!".format(serviceConfig.refreshTime)),loadData(!0)},serviceConfig.refreshTime))};init(),loadData(),$scope.uid=serviceConfig.getUid()}),app.controller("CtrlQRCode",function($scope,$stateParams,$state,serviceConfig,serviceLog,Dialog,serviceHttp){"use strict";var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,serviceHttp.aliPay(function(res){$scope.alipayImg="data:image/png;base64,"+res.qrpng}),1===$stateParams.wxmemberpay?serviceHttp.weixinMemberPay(function(res){$scope.wxpayImg="data:image/png;base64,"+res.qrpng}):serviceHttp.weixinPay(function(res){$scope.wxpayImg="data:image/png;base64,"+res.qrpng})};$scope.check=function(){serviceHttp.checkPay(!1,function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)},function(res){Dialog.showAlert("温馨提示",res)})},init()}),app.controller("CtrlWXQRCode",function($scope,$state,$stateParams,serviceConfig,serviceLog,Dialog,serviceHttp){"use strict";var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,serviceHttp.weixinPay(function(res){$scope.wxpayImg="data:image/png;base64,"+res.qrpng})};$scope.check=function(){serviceHttp.checkPay(!1,function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)},function(res){Dialog.showAlert("温馨提示",res)})},init()}),app.controller("CtrlLogin",function($scope,$state,$stateParams,serviceHttp,Dialog,serviceConfig,serviceLog){"use strict";var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.orderDomain=$stateParams.orderDomain,$scope.user={},$scope.user.userid="",$scope.user.password=""};$scope.bnCancel=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("root",par)},$scope.bnOk=function(){serviceHttp.login($scope.user.userid,$scope.user.password,function(){serviceLog.print("UserInfor:",$scope.user),serviceConfig.waiter=$scope.user.userid,serviceConfig.ascode=$scope.user.password;var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("server",par)})},init()}),app.controller("CtrlPay2",function($scope,$state,$rootScope,$stateParams,AppData,serviceUtils,LoginModal,serviceConfig,serviceLog,serviceHttp){"use strict";$scope.tableNum="",$scope.orderCount=0,$scope.payOrderCount=0;var getUrlVars=function(name){for(var hash,vars=[],hashes=window.location.href.slice(window.location.href.lastIndexOf("?")+1).split("&"),i=0;i<hashes.length;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars[name]};$scope.bnReg=function(){var url="http://wx.yumstone.com/weixin/"+serviceConfig.sellerId+"/vip/showcreatevip.html";location.href=url},$scope.pay=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,tableNum:serviceConfig.tableNum,orderDomain:serviceConfig.orderDomain};$state.go("pay",par)};var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.dogNum=getUrlVars("dog")||serviceConfig.dogNum,serviceLog.print("Dog:",serviceConfig.dogNum),""!=$stateParams.orderDomain&&(serviceConfig.orderDomain=$stateParams.orderDomain),
$scope.tableNum=serviceConfig.tableNum,""===serviceConfig.getUid()?serviceHttp.createUidFromServer(function(uid){serviceConfig.setUid(uid),serviceLog.print("Create New Uid:",serviceConfig.getUid())}):serviceLog.print("LocalStorage Exist Uid:",serviceConfig.getUid()),serviceHttp.checkPay(!0,function(){$scope.payOrderCount=0,serviceConfig.cover=0}),serviceHttp.getBillState(function(bill){$scope.orderCount=bill.orderCount,$scope.payOrderCount=bill.payOrderCount,0===bill.payOrderCount&&0===bill.payedCount&&(serviceConfig.cover=0)}),serviceConfig.clearWaiter()};init()}),app.controller("CtrlCheckpay",function($scope,$state,$stateParams,AppData,serviceUtils,serviceConfig,serviceLog,serviceHttp){"use strict";var checkPay=function(){serviceHttp.checkPay(!1,function(){$scope.result.success=!0,$scope.result.error=!1,$scope.result.msg=""},function(msg){$scope.result.success=!1,$scope.result.error=!0,$scope.result.msg=msg})};$scope.bnRefresh=function(){checkPay()},$scope.bnGoAccount=function(){window.location.href="{0}/{1}/vip/loginVip/1.html".format(serviceConfig.dicDomain,serviceConfig.sellerId)};var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,serviceConfig.tableNum=$stateParams.tableNum||serviceConfig.tableNum,serviceConfig.dogNum=SystemUtils.getUrlVars("dog")||serviceConfig.dogNum,serviceLog.print("Dog:",serviceConfig.dogNum),$scope.result={success:!1,error:!1,msg:""},""!=$stateParams.orderDomain&&(serviceConfig.orderDomain=$stateParams.orderDomain),checkPay()};init()}),app.controller("CtrlPreOrderV2",function($scope,$state,$stateParams,$ionicScrollDelegate,serviceUtils,serviceHttp,serviceLog,Dialog,serviceConfig,serviceSuiteModal,serviceNoSuiteModal,$timeout){"use strict";var yumstome=function(){$timeout(function(){$scope.yumstome=!0},3e3)};$scope.bnOrdered=function(){if($scope.ordered.qty<=0)Dialog.showAlert("温馨提示","您尚未点菜，请您先点菜！");else{var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId,orderDomain:serviceConfig.orderDomain};$state.go("preordered",par)}},$scope.typeClick=function(item){var v=document.getElementById(item.code).offsetTop;$ionicScrollDelegate.$getByHandle("order-v2").scrollTo(0,v,!1)};var addDataToCar=function(nopriceRemark,remark,scope,_type){scope.menuItem.num=scope.menuItem.num?scope.menuItem.num:0,scope.menuItem.num=scope.menuItem.num+scope.currentQty;var _orderType={code:_type.code,name:_type.name,isGroup:0},_orderItem={code:scope.menuItem.code,name:scope.menuItem.name,sndname:scope.menuItem.sndname,price:scope.menuItem.price,memberprice:scope.menuItem.memberprice||"0",standard:scope.menuItem.standard,num:scope.currentQty,memo:nopriceRemark,menuItem:remark};serviceUtils.appendNoSuiteData(_orderType,_orderItem),serviceNoSuiteModal.hide(),_orderItem.uid=serviceConfig.getUid();var food={code:_type.code,name:_type.name,ename:_type.sndname||"",isGroup:0,menuItem:_orderItem};serviceHttp.addPreFood(food)},addSuiteDataToCar=function(food,suite){serviceHttp.addPreFood(food,function(res){res&&(serviceUtils.calculateTypeNum(),serviceUtils.calculateCarTotal())}),serviceUtils.appendSuiteData(suite)};$scope.bnDetail=function(item,type){item.num=item.num||0,serviceLog.print("bnDetail..."),item.isSaleout||(1===type.isGroup?(item.oderedNum=1,serviceSuiteModal.show(item,addSuiteDataToCar)):0===type.isGroup&&(item.oderedNum=1,1==item.memoflag?(serviceLog.print("have sidedish..."),serviceNoSuiteModal.show(item,type,addDataToCar)):angular.isArray(item.remark)&&item.remark.length>0?(serviceLog.print("have add menu..."),serviceNoSuiteModal.show(item,type,addDataToCar)):0!=item.picMode?serviceNoSuiteModal.show(item,type,addDataToCar):item.standards.length>1?serviceNoSuiteModal.show(item,type,addDataToCar):Dialog.showSelectQty(item,function(qty){item.num=qty;var _type={code:type.code,isGroup:0,name:type.name},_item={code:item.code,name:item.name,sndname:item.sndname,price:item.price,memberprice:item.memberprice||"0",standard:item.standard,num:qty,menuItem:[],memo:""};serviceUtils.appendNoSuiteData(_type,_item),_item.uid=serviceConfig.getUid();var food={code:type.code,name:type.name,ename:type.sndname||"",isGroup:0,menuItem:_item};serviceHttp.addPreFood(food)})))};var loadOrginMenuData=function(){serviceHttp.getOriginMenuData(function(){$scope.types=serviceUtils.menuData})},loadPicData=function(){serviceHttp.getPicData(function(){loadOrginMenuData(),yumstome()})},loadSideDish=function(){serviceHttp.getSideDish()},refresh=function(){serviceUtils.calculateCarTotal(),serviceHttp.getPreFood(function(data){console.log("已点菜预点单：",data),serviceUtils.billData.length=0,serviceUtils.billData.append(data.data||[]),serviceUtils.calculateTypeNum(),serviceUtils.calculateCarTotal()},!0)};$scope.$on("$ionicView.beforeEnter",function(){refresh(),serviceUtils.calculateTypeNum()});var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId,console.log("这是URl++++++++++++:"+serviceConfig.getStaticResourceHead()),$scope.picDomain=serviceConfig.test?"":"http://wxcdn.yumstone.com/weixin/document/",loadPicData(),loadSideDish(),refresh(),$scope.ordered=serviceUtils.orderedTotal,$scope.iconDomain=serviceConfig.themeDomain,serviceUtils.calculateCarTotal()};init()}),app.controller("CtrlPreOrdered",function($scope,$state,$stateParams,$rootScope,serviceSuiteModal,serviceOrderMemo,$interval,serviceUtils,serviceNoSuiteModal,serviceHttp,serviceConfig,serviceLog,Dialog){"use strict";var loadData=function(hideLoading){serviceHttp.getPreFood(function(data){console.log("返回购物车：",data),serviceUtils.billData=data.data||[],$scope.bill=[],$scope.bill=data},hideLoading)};$scope.bnRefresh=function(){loadData(!0)};var updateOrderMemo=function(type,food){var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:0},_menuItem={code:type.code,name:type.name,ename:type.ename,isGroup:type.isGroup,menuItem:food};serviceHttp.updatePreFoodNum(_d),serviceHttp.addPreFood(_menuItem,function(){loadData()})};$scope.foodDetil=function(type,food){serviceOrderMemo.show(food,type,updateOrderMemo)},$scope.bnAddFood=function(){var par={sellerId:serviceConfig.sellerId,storeId:serviceConfig.storeId};$state.go("preorderv2",par)},$scope.bnMinus=function(food,$index){event.stopPropagation(),serviceLog.print("Minus:",food),food.num--,food.num=Math.max(0,food.num);var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:food.num};serviceHttp.updatePreFoodNum(_d,function(){loadData(),serviceUtils.calculateTypeNum(),0==food.num&&(food.hide=1)})},$scope.bnAdd=function(food,type){if(event.stopPropagation(),0===type.isGroup&&angular.isArray(food.menuItem)&&food.menuItem.length>0)Dialog.showAlert("温馨提示","该菜有附加收费项目，请到点菜界面加菜!");else{food.num++,food.num=Math.min(20,food.num);var _d={orderid:food.orderid,uid:serviceConfig.getUid(),num:food.num};serviceHttp.updatePreFoodNum(_d,function(){loadData(),serviceUtils.calculateTypeNum()})}};var init=function(){serviceConfig.sellerId=$stateParams.sellerId||serviceConfig.sellerId,serviceConfig.storeId=$stateParams.storeId||serviceConfig.storeId};init(),loadData(),$scope.uid=serviceConfig.getUid()});